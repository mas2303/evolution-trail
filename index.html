<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Road to GT85</title>
    
    <!-- Tailwind CSS (Design) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Recharts (Graphiques) - Chargé via CDN pour React/Babel simple -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loading-screen { position: fixed; inset: 0; background: white; z-index: 50; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-24 select-none">

    <!-- Écran de chargement -->
    <div id="loading" class="loading-screen">
        <div class="text-center">
            <h1 class="text-3xl font-black italic mb-2">GT85</h1>
            <p class="text-slate-400 text-sm animate-pulse">Chargement des données...</p>
        </div>
    </div>

    <!-- En-tête -->
    <header class="px-6 pt-8 pb-4 bg-white shadow-sm sticky top-0 z-30">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-black italic tracking-tighter uppercase">Road to <span class="text-blue-600">GT85</span></h1>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em]">Cloud Database Sync</p>
            </div>
            <div id="user-status" class="w-3 h-3 rounded-full bg-red-500 shadow-md"></div>
        </div>
    </header>

    <!-- Contenu Principal -->
    <main class="px-4 mt-4">
        
        <!-- DASHBOARD TAB -->
        <div id="tab-dashboard" class="tab-content active space-y-6">
            <!-- Stats Cards -->
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                    <p class="text-[10px] text-blue-600 font-bold uppercase">Distance Totale</p>
                    <p class="text-2xl font-black text-blue-900"><span id="stat-km">0</span> <span class="text-xs">km</span></p>
                </div>
                <div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-100">
                    <p class="text-[10px] text-emerald-600 font-bold uppercase">Dénivelé Total</p>
                    <p class="text-2xl font-black text-emerald-900"><span id="stat-dplus">0</span> <span class="text-xs">m</span></p>
                </div>
                <div class="bg-amber-50 p-4 rounded-2xl border border-amber-100">
                    <p class="text-[10px] text-amber-600 font-bold uppercase">Moyenne RPE</p>
                    <p class="text-2xl font-black text-amber-900"><span id="stat-rpe">0</span><span class="text-xs">/10</span></p>
                </div>
                <div class="bg-slate-100 p-4 rounded-2xl border border-slate-200">
                    <p class="text-[10px] text-slate-500 font-bold uppercase">Sessions PPG</p>
                    <p class="text-2xl font-black text-slate-800"><span id="stat-ppg">0</span></p>
                </div>
            </div>

            <!-- Progression Bar -->
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i data-lucide="calendar" class="w-4 h-4 text-blue-600"></i> Objectif GT85
                </h3>
                <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden">
                    <div id="progression-bar" class="bg-blue-600 h-full transition-all duration-1000" style="width: 0%"></div>
                </div>
                <div class="flex justify-between mt-2 text-xs font-bold text-slate-400">
                    <span>0 km</span>
                    <span id="progression-text">0%</span>
                    <span>500 km (Cycle)</span>
                </div>
            </div>
        </div>

        <!-- JOURNAL TAB -->
        <div id="tab-journal" class="tab-content space-y-4">
            <div class="flex justify-between items-center px-1">
                <h2 class="text-xl font-black text-slate-800">Séances</h2>
                <button onclick="openModal()" class="bg-blue-600 text-white p-2 rounded-full shadow-lg active:scale-95 transition-transform">
                    <i data-lucide="plus" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="sessions-list" class="space-y-3 pb-20">
                <!-- Les séances seront injectées ici par JS -->
                <p class="text-center text-slate-400 py-10 italic">Aucune donnée chargée...</p>
            </div>
        </div>

        <!-- PPG TAB -->
        <div id="tab-ppg" class="tab-content space-y-4">
            <div class="bg-slate-900 p-6 rounded-3xl text-white shadow-xl relative overflow-hidden">
                <div class="absolute right-[-20px] bottom-[-20px] opacity-10"><i data-lucide="shield" class="w-32 h-32"></i></div>
                <h2 class="text-xl font-black mb-1">Programme "L'Armure"</h2>
                <p class="text-xs text-slate-400">Renforcement spécifique Ultra-Trail.</p>
            </div>
            <div id="ppg-list" class="space-y-3">
                <!-- JS injectera la liste ici -->
            </div>
            <button onclick="resetPPG()" class="w-full py-3 text-xs font-bold text-slate-400 uppercase tracking-widest mt-4">Réinitialiser la séance</button>
        </div>

        <!-- MATOS TAB -->
        <div id="tab-gear" class="tab-content space-y-3">
            <h2 class="text-xl font-black text-slate-800 px-1">Matériel & Budget</h2>
            <div id="gear-list" class="space-y-3 pb-20">
                <!-- JS injectera le matos ici -->
            </div>
        </div>

    </main>

    <!-- Navigation -->
    <nav class="fixed bottom-6 left-6 right-6 bg-white/90 backdrop-blur-xl border border-slate-200 rounded-3xl shadow-2xl p-2 flex justify-around items-center z-40">
        <button onclick="switchTab('dashboard')" class="nav-btn active flex-1 flex flex-col items-center py-2 text-blue-600 transition-colors">
            <i data-lucide="trending-up" class="w-5 h-5"></i>
            <span class="text-[9px] font-black uppercase mt-1">Stats</span>
        </button>
        <button onclick="switchTab('journal')" class="nav-btn flex-1 flex flex-col items-center py-2 text-slate-400 hover:text-slate-600 transition-colors">
            <i data-lucide="activity" class="w-5 h-5"></i>
            <span class="text-[9px] font-black uppercase mt-1">Journal</span>
        </button>
        <button onclick="switchTab('ppg')" class="nav-btn flex-1 flex flex-col items-center py-2 text-slate-400 hover:text-slate-600 transition-colors">
            <i data-lucide="shield" class="w-5 h-5"></i>
            <span class="text-[9px] font-black uppercase mt-1">PPG</span>
        </button>
        <button onclick="switchTab('gear')" class="nav-btn flex-1 flex flex-col items-center py-2 text-slate-400 hover:text-slate-600 transition-colors">
            <i data-lucide="package" class="w-5 h-5"></i>
            <span class="text-[9px] font-black uppercase mt-1">Matos</span>
        </button>
    </nav>

    <!-- Modal Ajout Séance -->
    <div id="add-modal" class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm hidden flex items-end sm:items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl animate-[fadeIn_0.3s_ease-out]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Ajouter Séance</h3>
                <button onclick="closeModal()" class="p-2 bg-slate-100 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="add-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <input name="date" type="date" required class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold" id="date-input">
                    <select name="type" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold">
                        <option>EF (Footing)</option>
                        <option>Sortie Longue</option>
                        <option>Trail / D+</option>
                        <option>VMA / Seuil</option>
                        <option>PPG Seule</option>
                    </select>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <input name="km" type="number" step="0.1" placeholder="KM" required class="bg-slate-50 p-3 rounded-xl text-sm font-bold">
                    <input name="dPlus" type="number" placeholder="D+" required class="bg-slate-50 p-3 rounded-xl text-sm font-bold">
                    <input name="rpe" type="number" min="1" max="10" placeholder="RPE" required class="bg-slate-50 p-3 rounded-xl text-sm font-bold">
                </div>
                <div class="flex items-center gap-3 bg-slate-50 p-3 rounded-xl">
                    <input type="checkbox" name="ppg" id="ppg-check" class="w-5 h-5 accent-blue-600">
                    <label htmlFor="ppg-check" class="text-sm font-bold text-slate-600">Session PPG incluse ?</label>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-500/20 active:scale-95 transition-all">ENREGISTRER</button>
            </form>
        </div>
    </div>

    <!-- Scripts Firebase et Logique -->
    <script type="module">
        // -------------------------------------------------------------
        // CONFIGURATION FIREBASE - C'EST ICI QUE TU DOIS COLLER TES INFOS
        // -------------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, deleteDoc, doc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // REMPLACE CECI PAR TA CONFIGURATION FIREBASE (Voir Guide Markdown)
        const firebaseConfig = {
           apiKey: "AIzaSyByuABj8lDBXQWQI_V-Gsk-iN4XwbNk5UI",
            authDomain: "road-to-gt85.firebaseapp.com",
            projectId: "road-to-gt85",
            storageBucket: "road-to-gt85.firebasestorage.app",
            messagingSenderId: "337729038344",
            appId: "1:337729038344:web:37c9b098976b67558cc9bd",
            measurementId: "G-3RZFR8H9CN"
        };

        // --- Initialisation ---
        let app, db, auth, userId;
        
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Authentification Anonyme (Pour avoir un ID unique par appareil/navigateur)
            signInAnonymously(auth).catch((error) => {
                console.error("Erreur Auth:", error);
                alert("Erreur de connexion à la base de données. Vérifiez la configuration.");
            });

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-status').classList.remove('bg-red-500');
                    document.getElementById('user-status').classList.add('bg-green-500');
                    document.getElementById('loading').style.display = 'none';
                    initDataListeners();
                }
            });

        } catch (e) {
            console.error("Firebase non configuré", e);
            alert("Firebase n'est pas configuré ! Ouvre le fichier index.html et ajoute ta configuration.");
        }

        // --- Données Statiques ---
        const PPG_EXERCISES = [
            { id: 'chaise', name: "Chaise (Mur)", info: "4x45s • Cuisses" },
            { id: 'squat', name: "Squats", info: "3x20 • Puissance" },
            { id: 'fentes', name: "Fentes", info: "3x12/j • Stabilité" },
            { id: 'gainage', name: "Gainage", info: "4x1min • Tronc" },
            { id: 'proprio', name: "Proprioception", info: "3x30s • Chevilles" }
        ];

        const GEAR_ITEMS = [
            { id: 'sac', name: "Sac 12L", model: "Salomon Adv Skin", price: 120, status: 'A acheter' },
            { id: 'batons', name: "Bâtons", model: "Leki Ultratrail", price: 180, status: 'A acheter' },
            { id: 'shoes', name: "Chaussures", model: "Hoka Speedgoat", price: 160, status: 'Acquis' },
            { id: 'lamp', name: "Frontale", model: "Petzl Swift RL", price: 100, status: 'A acheter' }
        ];

        // --- Logique Application ---

        function initDataListeners() {
            // 1. Écouteur Sessions
            const qSessions = query(collection(db, `users/${userId}/sessions`), orderBy("date", "desc"));
            onSnapshot(qSessions, (snapshot) => {
                const sessions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSessions(sessions);
                calculateStats(sessions);
            });

            // 2. Écouteur PPG Check
            const qPPG = collection(db, `users/${userId}/ppg_status`);
            onSnapshot(qPPG, (snapshot) => {
                const ppgStatus = {};
                snapshot.docs.forEach(doc => ppgStatus[doc.id] = doc.data().done);
                renderPPG(ppgStatus);
            });

            // 3. Écouteur Gear
            const qGear = collection(db, `users/${userId}/gear_status`);
            onSnapshot(qGear, (snapshot) => {
                const gearStatus = {};
                snapshot.docs.forEach(doc => gearStatus[doc.id] = doc.data().status);
                renderGear(gearStatus);
            });
        }

        // --- Rendu HTML ---

        function renderSessions(sessions) {
            const container = document.getElementById('sessions-list');
            container.innerHTML = '';
            
            if(sessions.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-400 py-10 italic">Aucune séance enregistrée.</p>';
                return;
            }

            sessions.forEach(s => {
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex items-center justify-between";
                div.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-[10px] font-bold text-blue-500 uppercase bg-blue-50 px-2 py-0.5 rounded">${new Date(s.date).toLocaleDateString('fr-FR', {day: '2-digit', month: '2-digit'})}</span>
                            <span class="text-xs font-bold text-slate-700">${s.type}</span>
                        </div>
                        <div class="flex gap-3 text-sm font-black text-slate-800">
                           <span>${s.km} km</span>
                           <span class="text-slate-300">|</span>
                           <span>${s.dPlus} m D+</span>
                        </div>
                        ${s.ppg ? '<span class="text-[9px] text-emerald-600 font-bold flex items-center gap-1 mt-1"><i data-lucide="check-circle-2" class="w-3 h-3"></i> PPG INCLUSE</span>' : ''}
                    </div>
                    <button class="delete-btn text-slate-300 hover:text-red-500 p-2" data-id="${s.id}">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                `;
                container.appendChild(div);
            });
            lucide.createIcons();
            
            // Attach delete events
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => deleteSession(btn.dataset.id));
            });
        }

        function calculateStats(sessions) {
            const totalKm = sessions.reduce((acc, s) => acc + (parseFloat(s.km) || 0), 0);
            const totalDPlus = sessions.reduce((acc, s) => acc + (parseInt(s.dPlus) || 0), 0);
            const avgRPE = sessions.length ? (sessions.reduce((acc, s) => acc + (parseInt(s.rpe) || 0), 0) / sessions.length).toFixed(1) : 0;
            const ppgCount = sessions.filter(s => s.ppg).length;

            document.getElementById('stat-km').innerText = totalKm.toFixed(1);
            document.getElementById('stat-dplus').innerText = totalDPlus;
            document.getElementById('stat-rpe').innerText = avgRPE;
            document.getElementById('stat-ppg').innerText = ppgCount;

            const progress = Math.min(100, (totalKm / 500) * 100);
            document.getElementById('progression-bar').style.width = `${progress}%`;
            document.getElementById('progression-text').innerText = `${progress.toFixed(0)}%`;
        }

        function renderPPG(statusMap) {
            const container = document.getElementById('ppg-list');
            container.innerHTML = '';
            
            PPG_EXERCISES.forEach(ex => {
                const isDone = statusMap[ex.id] === true;
                const div = document.createElement('div');
                div.className = `p-4 rounded-2xl border cursor-pointer flex justify-between items-center transition-all ${isDone ? 'bg-emerald-50 border-emerald-200' : 'bg-white border-slate-100'}`;
                div.onclick = () => togglePPG(ex.id, !isDone);
                div.innerHTML = `
                    <div>
                        <h4 class="font-bold ${isDone ? 'text-emerald-700 line-through' : 'text-slate-800'}">${ex.name}</h4>
                        <p class="text-xs text-slate-500">${ex.info}</p>
                    </div>
                    <div class="${isDone ? 'text-emerald-500' : 'text-slate-200'}">
                        <i data-lucide="check-circle-2" class="w-6 h-6"></i>
                    </div>
                `;
                container.appendChild(div);
            });
            lucide.createIcons();
        }

        function renderGear(statusMap) {
            const container = document.getElementById('gear-list');
            container.innerHTML = '';
            
            GEAR_ITEMS.forEach(item => {
                // Use stored status or default
                const currentStatus = statusMap[item.id] || item.status;
                const isAcquired = currentStatus === 'Acquis';
                
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-4";
                div.innerHTML = `
                    <div class="w-10 h-10 rounded-xl flex items-center justify-center ${isAcquired ? 'bg-emerald-100 text-emerald-600' : 'bg-amber-100 text-amber-600'}">
                        <i data-lucide="package" class="w-5 h-5"></i>
                    </div>
                    <div class="flex-1">
                        <h4 class="text-sm font-bold leading-tight">${item.name}</h4>
                        <p class="text-[10px] text-slate-500">${item.model}</p>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <span class="text-[10px] font-black text-blue-600">${item.price}€</span>
                        <button class="gear-toggle text-[9px] font-black px-2 py-1 rounded-lg uppercase tracking-tighter ${isAcquired ? 'bg-emerald-50 text-emerald-700' : 'bg-slate-100 text-slate-600'}" data-id="${item.id}" data-status="${currentStatus}">
                            ${currentStatus}
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
            lucide.createIcons();

            document.querySelectorAll('.gear-toggle').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const newStatus = btn.dataset.status === 'Acquis' ? 'A acheter' : 'Acquis';
                    toggleGear(btn.dataset.id, newStatus);
                });
            });
        }

        // --- Actions Firestore ---

        async function addSession(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            try {
                await addDoc(collection(db, `users/${userId}/sessions`), {
                    date: formData.get('date'),
                    type: formData.get('type'),
                    km: parseFloat(formData.get('km') || 0),
                    dPlus: parseInt(formData.get('dPlus') || 0),
                    rpe: parseInt(formData.get('rpe') || 0),
                    ppg: formData.get('ppg') === 'on',
                    timestamp: new Date()
                });
                closeModal();
                e.target.reset();
            } catch (err) {
                console.error("Erreur ajout:", err);
                alert("Erreur lors de l'enregistrement");
            }
        }

        window.deleteSession = async (id) => {
            if(confirm('Supprimer ?')) {
                await deleteDoc(doc(db, `users/${userId}/sessions`, id));
            }
        }

        window.togglePPG = async (id, status) => {
            await setDoc(doc(db, `users/${userId}/ppg_status`, id), { done: status }, { merge: true });
        }

        window.toggleGear = async (id, status) => {
            await setDoc(doc(db, `users/${userId}/gear_status`, id), { status: status }, { merge: true });
        }
        
        window.resetPPG = async () => {
             PPG_EXERCISES.forEach(async (ex) => {
                 await setDoc(doc(db, `users/${userId}/ppg_status`, ex.id), { done: false });
             });
        }

        // Expose functions to global scope for HTML onclick
        document.getElementById('add-form').addEventListener('submit', addSession);

    </script>

    <!-- UI Scripts (Tabs & Modal) -->
    <script>
        function switchTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => {
                el.classList.remove('text-blue-600', 'active');
                el.classList.add('text-slate-400');
            });

            // Show selected
            document.getElementById('tab-' + tabId).classList.add('active');
            
            // Highlight nav
            const activeBtn = document.querySelector(`button[onclick="switchTab('${tabId}')"]`);
            if(activeBtn) {
                activeBtn.classList.remove('text-slate-400');
                activeBtn.classList.add('text-blue-600', 'active');
            }
        }

        function openModal() {
            document.getElementById('add-modal').classList.remove('hidden');
            document.getElementById('date-input').valueAsDate = new Date();
        }

        function closeModal() {
            document.getElementById('add-modal').classList.add('hidden');
        }
        
        // Init Icons
        lucide.createIcons();
    </script>
</body>
</html>