import React, { useState, useEffect, useMemo } from 'react';
import { 
  BarChart, Bar, XAxis, Tooltip, ResponsiveContainer
} from 'recharts';
import { 
  Activity, 
  Shield, 
  Package, 
  Heart, 
  TrendingUp, 
  Plus, 
  Calendar, 
  CheckCircle2, 
  Trash2, 
  X
} from 'lucide-react';

// --- DONNÉES PAR DÉFAUT ---
const DEFAULT_SESSIONS = [
  { id: 1, date: '2025-01-20', type: 'Planning', km: 0, dPlus: 0, duration: '00:30', rpe: 1, ppg: false },
  { id: 2, date: '2025-01-21', type: 'EF (Footing)', km: 8, dPlus: 50, duration: '01:00', rpe: 2, ppg: true }
];

const DEFAULT_GEAR = [
  { id: 1, equipement: "Sac 12L", modele: "Salomon Adv Skin 12", etat: "A acheter", budget: 120 },
  { id: 2, equipement: "Bâtons", modele: "Leki Ultratrail FX.One", etat: "A acheter", budget: 180 },
  { id: 3, equipement: "Chaussures", modele: "Hoka Speedgoat", etat: "Acquis", budget: 160 },
  { id: 4, equipement: "Frontale", modele: "Petzl Swift RL", etat: "A acheter", budget: 100 }
];

const PPG_LIST = [
  { id: 1, exercice: "Chaise", goal: "4 x 45s", focus: "Cuisses" },
  { id: 2, exercice: "Squats", goal: "3 x 20", focus: "Puissance" },
  { id: 3, exercice: "Gainage", goal: "4 x 1 min", focus: "Stabilité" },
  { id: 4, exercice: "Proprioception", goal: "3 x 30s", focus: "Chevilles" }
];

const HEART_ZONES = [
  { zone: "Z1", range: "< 130", label: "Récup", color: "#22c55e" },
  { zone: "Z2", range: "130-145", label: "Endurance", color: "#3b82f6" },
  { zone: "Z3", range: "145-160", label: "Tempo", color: "#eab308" },
  { zone: "Z4", range: "160-175", label: "Seuil", color: "#f97316" },
  { zone: "Z5", range: "> 175", label: "VMA", color: "#ef4444" }
];

// --- FONCTIONS DE SAUVEGARDE SÉCURISÉES ---
const safeGetStorage = (key, fallback) => {
  if (typeof window === 'undefined') return fallback;
  try {
    const saved = localStorage.getItem(key);
    return saved ? JSON.parse(saved) : fallback;
  } catch (e) {
    console.warn("Erreur lecture stockage", e);
    return fallback;
  }
};

const safeSetStorage = (key, value) => {
  if (typeof window === 'undefined') return;
  try {
    localStorage.setItem(key, JSON.stringify(value));
  } catch (e) {
    console.warn("Erreur écriture stockage", e);
  }
};

// --- COMPOSANT PRINCIPAL ---
const App = () => {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [sessions, setSessions] = useState(() => safeGetStorage('gt85_sessions', DEFAULT_SESSIONS));
  const [gear, setGear] = useState(() => safeGetStorage('gt85_gear', DEFAULT_GEAR));
  const [ppgDone, setPpgDone] = useState(() => safeGetStorage('gt85_ppg_done', []));
  const [showAddModal, setShowAddModal] = useState(false);

  // Sauvegarde à chaque changement
  useEffect(() => safeSetStorage('gt85_sessions', sessions), [sessions]);
  useEffect(() => safeSetStorage('gt85_gear', gear), [gear]);
  useEffect(() => safeSetStorage('gt85_ppg_done', ppgDone), [ppgDone]);

  // Calculs Stats
  const stats = useMemo(() => {
    const totalKm = sessions.reduce((acc, s) => acc + (parseFloat(s.km) || 0), 0);
    const totalDPlus = sessions.reduce((acc, s) => acc + (parseInt(s.dPlus) || 0), 0);
    const avgRPE = sessions.length ? (sessions.reduce((acc, s) => acc + (parseInt(s.rpe) || 0), 0) / sessions.length).toFixed(1) : 0;
    const ppgCount = sessions.filter(s => s.ppg).length;
    return { totalKm, totalDPlus, avgRPE, count: sessions.length, ppgCount };
  }, [sessions]);

  // Actions
  const addSession = (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const newSession = {
      id: Date.now(),
      date: formData.get('date'),
      type: formData.get('type'),
      km: parseFloat(formData.get('km') || 0),
      dPlus: parseInt(formData.get('dPlus') || 0),
      duration: formData.get('duration') || '00:00',
      rpe: parseInt(formData.get('rpe') || 1),
      ppg: formData.get('ppg') === 'on'
    };
    setSessions([newSession, ...sessions]);
    setShowAddModal(false);
  };

  const deleteSession = (id) => {
    setSessions(sessions.filter(s => s.id !== id));
  };

  const toggleGear = (id) => {
    setGear(gear.map(g => g.id === id ? { ...g, etat: g.etat === 'Acquis' ? 'A acheter' : 'Acquis' } : g));
  };

  const togglePPG = (id) => {
    setPpgDone(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
  };

  // --- VUES ---
  const DashboardView = () => (
    <div className="space-y-6">
      {/* KPI Cards */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
          <p className="text-xs text-blue-600 font-bold uppercase">Distance</p>
          <p className="text-2xl font-black text-blue-900">{stats.totalKm.toFixed(1)} km</p>
        </div>
        <div className="bg-emerald-50 p-4 rounded-xl border border-emerald-100">
          <p className="text-xs text-emerald-600 font-bold uppercase">Dénivelé</p>
          <p className="text-2xl font-black text-emerald-900">{stats.totalDPlus} m</p>
        </div>
        <div className="bg-amber-50 p-4 rounded-xl border border-amber-100">
          <p className="text-xs text-amber-600 font-bold uppercase">RPE Moy.</p>
          <p className="text-2xl font-black text-amber-900">{stats.avgRPE}/10</p>
        </div>
        <div className="bg-slate-100 p-4 rounded-xl border border-slate-200">
          <p className="text-xs text-slate-500 font-bold uppercase">PPG Total</p>
          <p className="text-2xl font-black text-slate-800">{stats.ppgCount}</p>
        </div>
      </div>

      {/* Chart */}
      <div className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
        <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
          <TrendingUp size={18} className="text-blue-600"/> Volume Hebdo
        </h3>
        <div className="h-48 w-full">
          <ResponsiveContainer width="100%" height="100%">
            <BarChart data={[...sessions].reverse().slice(-7)}>
              <XAxis dataKey="date" hide />
              <Tooltip cursor={{fill: 'transparent'}} contentStyle={{borderRadius: '8px', fontSize: '12px'}} />
              <Bar dataKey="km" fill="#3b82f6" radius={[4, 4, 0, 0]} />
            </BarChart>
          </ResponsiveContainer>
        </div>
      </div>

      {/* Objectif */}
      <div className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
        <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
          <Calendar size={18} className="text-blue-600"/> Objectif GT85
        </h3>
        <div className="w-full bg-slate-100 rounded-full h-3 overflow-hidden">
          <div className="bg-blue-600 h-full" style={{ width: `${Math.min(100, (stats.totalKm / 500) * 100)}%` }}></div>
        </div>
        <p className="text-xs text-right mt-1 text-slate-500 font-bold">Progression : {((stats.totalKm / 500) * 100).toFixed(0)}%</p>
      </div>
    </div>
  );

  const JournalView = () => (
    <div className="space-y-4">
      <div className="flex justify-between items-center">
        <h2 className="text-xl font-black text-slate-800">Séances</h2>
        <button onClick={() => setShowAddModal(true)} className="bg-blue-600 text-white p-2 rounded-full shadow-md">
          <Plus size={24} />
        </button>
      </div>
      
      {sessions.length === 0 && <p className="text-center text-slate-400 py-10">Aucune séance.</p>}

      {sessions.map(s => (
        <div key={s.id} className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex items-center justify-between">
          <div>
            <p className="text-xs font-bold text-blue-500 uppercase mb-1">{s.date} - {s.type}</p>
            <p className="font-black text-slate-700">{s.km} km | {s.dPlus} m D+</p>
          </div>
          <button onClick={() => deleteSession(s.id)} className="text-slate-300 hover:text-red-500">
            <Trash2 size={20} />
          </button>
        </div>
      ))}
    </div>
  );

  const PPGView = () => (
    <div className="space-y-4">
      <div className="bg-slate-800 p-5 rounded-2xl text-white">
        <h2 className="font-bold text-lg mb-1 flex items-center gap-2"><Shield size={20}/> Programme L'Armure</h2>
        <p className="text-sm text-slate-400">Renforcement musculaire</p>
      </div>
      <div className="grid gap-3">
        {PPG_LIST.map(ex => (
          <div key={ex.id} onClick={() => togglePPG(ex.id)} className={`p-4 rounded-xl border cursor-pointer flex justify-between items-center ${ppgDone.includes(ex.id) ? 'bg-emerald-50 border-emerald-200' : 'bg-white border-slate-200'}`}>
            <div>
              <p className={`font-bold ${ppgDone.includes(ex.id) ? 'text-emerald-700 line-through' : 'text-slate-800'}`}>{ex.exercice}</p>
              <p className="text-xs text-slate-500">{ex.goal}</p>
            </div>
            <CheckCircle2 size={24} className={ppgDone.includes(ex.id) ? 'text-emerald-500' : 'text-slate-200'} />
          </div>
        ))}
      </div>
      {ppgDone.length > 0 && (
        <button onClick={() => setPpgDone([])} className="w-full py-3 text-sm font-bold text-slate-500 uppercase">Réinitialiser</button>
      )}
    </div>
  );

  const GearView = () => (
    <div className="space-y-4">
      <h2 className="text-xl font-black text-slate-800">Matériel</h2>
      {gear.map(g => (
        <div key={g.id} className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-4">
          <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${g.etat === 'Acquis' ? 'bg-emerald-100 text-emerald-600' : 'bg-orange-100 text-orange-600'}`}>
            <Package size={20} />
          </div>
          <div className="flex-1">
            <p className="font-bold text-slate-800">{g.equipement}</p>
            <p className="text-xs text-slate-500">{g.modele} - <span className="text-blue-600 font-bold">{g.budget}€</span></p>
          </div>
          <button onClick={() => toggleGear(g.id)} className={`text-xs font-bold px-3 py-1 rounded-md uppercase ${g.etat === 'Acquis' ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-600'}`}>
            {g.etat}
          </button>
        </div>
      ))}
    </div>
  );

  // --- RENDU PRINCIPAL ---
  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 pb-24 font-sans">
      <header className="px-6 pt-8 pb-4 bg-white shadow-sm mb-4">
        <h1 className="text-2xl font-black italic tracking-tighter uppercase">Road to <span className="text-blue-600">GT85</span></h1>
      </header>

      <main className="px-4">
        {activeTab === 'dashboard' && <DashboardView />}
        {activeTab === 'journal' && <JournalView />}
        {activeTab === 'ppg' && <PPGView />}
        {activeTab === 'gear' && <GearView />}
      </main>

      {/* Modal Ajout */}
      {showAddModal && (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
          <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-xl">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-bold text-lg">Ajouter Séance</h3>
              <button onClick={() => setShowAddModal(false)}><X size={24}/></button>
            </div>
            <form onSubmit={addSession} className="space-y-3">
              <input name="date" type="date" required className="w-full bg-slate-100 p-3 rounded-lg text-sm" defaultValue={new Date().toISOString().split('T')[0]} />
              <select name="type" className="w-full bg-slate-100 p-3 rounded-lg text-sm">
                <option>EF (Footing)</option>
                <option>Sortie Longue</option>
                <option>Trail / D+</option>
                <option>VMA</option>
              </select>
              <div className="flex gap-3">
                <input name="km" type="number" step="0.1" placeholder="KM" required className="w-full bg-slate-100 p-3 rounded-lg text-sm" />
                <input name="dPlus" type="number" placeholder="D+" required className="w-full bg-slate-100 p-3 rounded-lg text-sm" />
              </div>
              <input name="rpe" type="number" min="1" max="10" placeholder="RPE (1-10)" required className="w-full bg-slate-100 p-3 rounded-lg text-sm" />
              <div className="flex items-center gap-2">
                <input type="checkbox" name="ppg" id="ppg-check" className="w-4 h-4"/>
                <label htmlFor="ppg-check" className="text-sm font-bold">Session PPG incluse ?</label>
              </div>
              <button type="submit" className="w-full bg-blue-600 text-white font-bold py-3 rounded-xl mt-2">Valider</button>
            </form>
          </div>
        </div>
      )}

      {/* Navigation */}
      <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-3 flex justify-around z-40 pb-6 safe-area-bottom">
        {[
          { id: 'dashboard', icon: TrendingUp, label: 'Stats' },
          { id: 'journal', icon: Activity, label: 'Journal' },
          { id: 'ppg', icon: Shield, label: 'PPG' },
          { id: 'gear', icon: Package, label: 'Matos' },
        ].map(tab => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id)}
            className={`flex flex-col items-center ${activeTab === tab.id ? 'text-blue-600' : 'text-slate-400'}`}
          >
            <tab.icon size={24} />
            <span className="text-[10px] font-bold uppercase mt-1">{tab.label}</span>
          </button>
        ))}
      </nav>
    </div>
  );
};

export default App;