<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Road to GT85 - Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Chart.js (Pour le graphique) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loading-screen { position: fixed; inset: 0; background: white; z-index: 50; display: flex; align-items: center; justify-content: center; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* Style sp√©cifique pour les inputs dur√©e */
        .time-input { text-align: center; padding-left: 0.5rem; padding-right: 0.5rem; }
        
        /* Styles Calendrier Compact */
        .calendar-container { max-width: 260px; margin: 0 auto; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; }
        .calendar-day { 
            aspect-ratio: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            border-radius: 6px; 
            font-size: 9px; 
            font-weight: bold; 
            color: #cbd5e1; 
            position: relative; 
        }
        .calendar-day.active { color: white; }
        .calendar-day.has-run { background-color: #3b82f6; color: white; }
        .calendar-day.today { border: 1.5px solid #ef4444; color: #ef4444; }
        .calendar-day.today.has-run { color: white; border: 1.5px solid white; }
        
        /* Styles Programme */
        .step-circle { width: 24px; height: 24px; border-radius: 50%; background: #eff6ff; color: #2563eb; font-size: 12px; font-weight: 900; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-28 select-none">

    <!-- √âcran de chargement -->
    <div id="loading" class="loading-screen">
        <div class="text-center">
            <h1 class="text-3xl font-black italic mb-2">GT85</h1>
            <p class="text-slate-400 text-sm animate-pulse">Chargement...</p>
        </div>
    </div>

    <!-- ZONE D'AUTHENTIFICATION (Visible si non connect√©) -->
    <div id="auth-container" class="hidden min-h-screen fixed inset-0 z-40 bg-slate-50 flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl">
            <h1 class="text-3xl font-black italic mb-2 text-center">ROAD TO <span class="text-blue-600">GT85</span></h1>
            <p id="auth-subtitle" class="text-center text-slate-400 text-sm mb-8 font-bold uppercase tracking-widest">Connexion</p>
            
            <form id="auth-form" class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold uppercase text-slate-400 ml-1">Email</label>
                    <input type="email" id="auth-email" required class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold border border-slate-100 outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="text-[10px] font-bold uppercase text-slate-400 ml-1">Mot de passe</label>
                    <input type="password" id="auth-password" required class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold border border-slate-100 outline-none focus:border-blue-500">
                </div>
                
                <!-- Zone d'erreur -->
                <div id="auth-error" class="hidden bg-red-50 text-red-500 p-3 rounded-xl text-xs font-bold text-center border border-red-100"></div>
                
                <button type="submit" id="btn-auth-submit" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-500/20 active:scale-95 transition-all">
                    SE CONNECTER
                </button>
                
                <div class="text-center mt-4">
                    <button type="button" id="btn-toggle-mode" onclick="toggleAuthMode()" class="text-xs text-slate-400 font-bold hover:text-blue-600 transition-colors">
                        Pas de compte ? Cr√©er un compte
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- APPLICATION PRINCIPALE (Visible si connect√©) -->
    <div id="app-container" class="hidden">
        
        <!-- En-t√™te -->
        <header class="px-6 pt-8 pb-4 bg-white shadow-sm sticky top-0 z-30">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-black italic tracking-tighter uppercase">Road to <span class="text-blue-600">GT85</span></h1>
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em]">v4.5 Accordion</span>
                        <span class="text-[9px] bg-emerald-100 text-emerald-600 px-2 rounded-full font-bold uppercase">Connect√©</span>
                    </div>
                </div>
                <button onclick="openSettings()" class="bg-slate-100 p-2 rounded-full text-slate-600 hover:bg-slate-200 transition-colors relative">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <!-- Contenu Principal -->
        <main class="px-4 mt-4">
            
            <!-- DASHBOARD TAB -->
            <div id="tab-dashboard" class="tab-content active space-y-6">
                <!-- Stats Cards -->
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                        <p class="text-[10px] text-blue-600 font-bold uppercase">Distance</p>
                        <p class="text-2xl font-black text-blue-900"><span id="stat-km">0</span> <span class="text-xs">km</span></p>
                    </div>
                    <div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-100">
                        <p class="text-[10px] text-emerald-600 font-bold uppercase">D√©nivel√©</p>
                        <p class="text-2xl font-black text-emerald-900"><span id="stat-dplus">0</span> <span class="text-xs">m</span></p>
                    </div>
                </div>

                <!-- Graphique d'√âvolution -->
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2 text-xs uppercase tracking-wider">
                        <i data-lucide="trending-up" class="w-4 h-4 text-blue-600"></i> Progression Hebdo
                    </h3>
                    <div class="h-48 w-full">
                        <canvas id="weeklyChart"></canvas>
                    </div>
                </div>

                <!-- Comparatif Semaines -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-3 opacity-10">
                            <i data-lucide="calendar-check-2" class="w-12 h-12 text-slate-800"></i>
                        </div>
                        <h3 class="font-bold text-slate-500 mb-2 flex items-center gap-2 text-xs uppercase tracking-wider relative z-10">Semaine Derni√®re</h3>
                        <div class="flex justify-between items-end relative z-10">
                            <div><span class="text-2xl font-black text-slate-800" id="last-week-km">0</span><span class="text-xs font-bold text-slate-400">km</span></div>
                            <div class="text-right pr-2"><span class="text-lg font-bold text-emerald-600" id="last-week-dplus">0</span><span class="text-[10px] font-bold text-slate-400 uppercase">m D+</span></div>
                        </div>
                    </div>
                    <div class="bg-blue-600 p-4 rounded-2xl shadow-lg shadow-blue-200 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-3 opacity-10"><i data-lucide="calendar-clock" class="w-12 h-12 text-white"></i></div>
                        <h3 class="font-bold text-blue-100 mb-2 flex items-center gap-2 text-xs uppercase tracking-wider relative z-10">Semaine en cours</h3>
                        <div class="flex justify-between items-end text-white relative z-10">
                            <div><span class="text-3xl font-black" id="current-week-km">0</span><span class="text-xs font-bold text-blue-200">km</span></div>
                            <div class="text-right pr-2"><span class="text-xl font-bold" id="current-week-dplus">0</span><span class="text-[10px] font-bold text-blue-200 uppercase">m D+</span></div>
                        </div>
                    </div>
                </div>

                <!-- CALENDRIER VISUEL COMPACT -->
                <div class="bg-white p-4 rounded-3xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-slate-800 flex items-center gap-2 text-xs uppercase tracking-wider">
                            <i data-lucide="calendar" class="w-4 h-4 text-blue-600"></i> Activit√©
                        </h3>
                        <div class="flex items-center gap-2">
                            <button onclick="changeMonth(-1)" class="p-1 hover:bg-slate-100 rounded text-slate-400 hover:text-slate-600"><i data-lucide="chevron-left" class="w-3 h-3"></i></button>
                            <span id="calendar-month-year" class="text-[10px] font-black uppercase text-slate-700 w-16 text-center">JAN 2025</span>
                            <button onclick="changeMonth(1)" class="p-1 hover:bg-slate-100 rounded text-slate-400 hover:text-slate-600"><i data-lucide="chevron-right" class="w-3 h-3"></i></button>
                        </div>
                    </div>
                    <div class="calendar-container">
                        <div class="grid grid-cols-7 gap-1 mb-1 text-center">
                            <div class="text-[8px] font-bold text-slate-300 uppercase">L</div>
                            <div class="text-[8px] font-bold text-slate-300 uppercase">M</div>
                            <div class="text-[8px] font-bold text-slate-300 uppercase">M</div>
                            <div class="text-[8px] font-bold text-slate-300 uppercase">J</div>
                            <div class="text-[8px] font-bold text-slate-300 uppercase">V</div>
                            <div class="text-[8px] font-bold text-slate-300 uppercase">S</div>
                            <div class="text-[8px] font-bold text-slate-300 uppercase">D</div>
                        </div>
                        <div id="calendar-days" class="calendar-grid"></div>
                    </div>
                    <div class="flex justify-center gap-3 mt-3 border-t border-slate-50 pt-2">
                        <div class="flex items-center gap-1"><div class="w-1.5 h-1.5 rounded-full bg-blue-300"></div><span class="text-[8px] text-slate-400 uppercase font-bold">Court</span></div>
                        <div class="flex items-center gap-1"><div class="w-1.5 h-1.5 rounded-full bg-blue-600"></div><span class="text-[8px] text-slate-400 uppercase font-bold">Long</span></div>
                        <div class="flex items-center gap-1"><div class="w-1.5 h-1.5 rounded-full bg-[#1e3a8a]"></div><span class="text-[8px] text-slate-400 uppercase font-bold">Ultra</span></div>
                    </div>
                </div>
            </div>

            <!-- NOUVEL ONGLET : PROGRAMME -->
            <div id="tab-program" class="tab-content space-y-4">
                <div class="flex items-center gap-3 mb-2 px-1">
                    <h2 class="text-xl font-black text-slate-800">Semaine Type</h2>
                </div>

                <!-- MARDI (ACCORD√âON) -->
                <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden cursor-pointer transition-all active:scale-[0.98]" onclick="toggleDetails('mardi')">
                    <div class="bg-slate-900 p-4 flex justify-between items-center text-white">
                        <div class="flex items-center gap-3">
                            <div class="bg-blue-600 p-2 rounded-lg"><i data-lucide="zap" class="w-5 h-5"></i></div>
                            <div>
                                <h3 class="font-black text-lg leading-none">MARDI</h3>
                                <p class="text-[10px] text-blue-200 uppercase font-bold tracking-wider">Vitesse & C√¥te</p>
                            </div>
                        </div>
                        <i id="chevron-mardi" data-lucide="chevron-down" class="w-6 h-6 text-slate-400 transition-transform duration-300"></i>
                    </div>
                    
                    <div id="details-mardi" class="hidden p-5 space-y-6 border-t border-slate-100">
                        <!-- √âchauffement -->
                        <div>
                            <h4 class="text-xs font-black uppercase text-slate-400 mb-3 tracking-widest flex items-center gap-2">
                                <i data-lucide="flame" class="w-3 h-3 text-orange-500"></i> √âchauffement (Indispensable)
                            </h4>
                            <div class="space-y-4 relative border-l-2 border-slate-100 ml-3 pl-6 pb-2">
                                <!-- Step 1 -->
                                <div class="relative">
                                    <div class="absolute -left-[33px] top-0 step-circle">1</div>
                                    <h5 class="font-bold text-sm text-slate-800">R√©veil Moteur (15 min)</h5>
                                    <p class="text-xs text-slate-500 mt-1">Trottez tr√®s lentement sur le plat. Vous devez pouvoir parler. Lubrifiez les articulations.</p>
                                </div>
                                <!-- Step 2 -->
                                <div class="relative">
                                    <div class="absolute -left-[33px] top-0 step-circle">2</div>
                                    <h5 class="font-bold text-sm text-slate-800">D√©verrouillage (2 min)</h5>
                                    <p class="text-xs text-slate-500 mt-1">√Ä l'arr√™t. Ronds de chevilles (important Speedgoat), cercles de hanches, flexions genoux.</p>
                                </div>
                                <!-- Step 3 -->
                                <div class="relative">
                                    <div class="absolute -left-[33px] top-0 step-circle">3</div>
                                    <h5 class="font-bold text-sm text-slate-800">Gammes (3 min)</h5>
                                    <p class="text-xs text-slate-500 mt-1">Talons-fesses (Ischios), Mont√©es de genoux (Buste droit), Pas chass√©s (Adducteurs). 2x sur 20m.</p>
                                </div>
                                <!-- Step 4 -->
                                <div class="relative">
                                    <div class="absolute -left-[33px] top-0 step-circle">4</div>
                                    <h5 class="font-bold text-sm text-slate-800">Lignes Droites</h5>
                                    <p class="text-xs text-slate-500 mt-1">2 ou 3 acc√©l√©rations progressives sur 50m (C≈ìur √† 80%). Marchez 1 min avant de lancer.</p>
                                </div>
                            </div>
                        </div>

                        <!-- S√©ance -->
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                            <h4 class="text-xs font-black uppercase text-blue-600 mb-2 tracking-widest">La S√©ance</h4>
                            <div class="flex gap-3 text-sm">
                                <span class="font-bold text-slate-700 w-12">Lieu :</span>
                                <span class="text-slate-600">C√¥te de la Charmille</span>
                            </div>
                            <div class="flex gap-3 text-sm mt-1">
                                <span class="font-bold text-slate-700 w-12">Action :</span>
                                <span class="text-slate-600">Navettes mont√©es/descentes ou fentes. Travail de force.</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- JEUDI -->
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 flex items-center gap-4">
                    <div class="bg-emerald-100 p-3 rounded-2xl text-emerald-600">
                        <i data-lucide="wind" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h3 class="font-black text-lg leading-none text-slate-800">JEUDI</h3>
                        <p class="text-[10px] text-emerald-600 uppercase font-bold tracking-wider mb-1">Endurance & Rythme</p>
                        <p class="text-xs text-slate-500">Extratrail Vert. On d√©roule, on travaille le souffle et la fluidit√©.</p>
                    </div>
                </div>

                <!-- DIMANCHE -->
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 flex items-center gap-4">
                    <div class="bg-amber-100 p-3 rounded-2xl text-amber-600">
                        <i data-lucide="map" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h3 class="font-black text-lg leading-none text-slate-800">DIMANCHE</h3>
                        <p class="text-[10px] text-amber-600 uppercase font-bold tracking-wider mb-1">Sortie Longue</p>
                        <p class="text-xs text-slate-500">Extratrail Bleu / Mix Charmille. Dur√©e vis√©e 1h30+. Marche en c√¥te, course sur plat.</p>
                    </div>
                </div>
                
                <div class="text-center py-4 opacity-50">
                    <i data-lucide="footprints" class="w-8 h-8 mx-auto text-slate-300 mb-2"></i>
                    <p class="text-[10px] uppercase font-bold text-slate-400">Le repos fait partie de l'entra√Ænement</p>
                </div>
            </div>

            <!-- JOURNAL TAB -->
            <div id="tab-journal" class="tab-content space-y-4">
                <div class="flex justify-between items-center px-1">
                    <h2 class="text-xl font-black text-slate-800">S√©ances</h2>
                    <button onclick="openModal()" class="bg-blue-600 text-white p-2 rounded-full shadow-lg active:scale-95 transition-transform">
                        <i data-lucide="plus" class="w-6 h-6"></i>
                    </button>
                </div>
                <div id="sessions-list" class="space-y-3 pb-20">
                    <p class="text-center text-slate-400 py-10 italic">Chargement...</p>
                </div>
            </div>

            <!-- PPG TAB -->
            <div id="tab-ppg" class="tab-content space-y-4">
                <div class="bg-slate-900 p-6 rounded-3xl text-white shadow-xl relative overflow-hidden">
                    <div class="absolute right-[-20px] bottom-[-20px] opacity-10"><i data-lucide="shield" class="w-32 h-32"></i></div>
                    <h2 class="text-xl font-black mb-1">Programme "L'Armure"</h2>
                    <p class="text-xs text-slate-400">Renforcement sp√©cifique Ultra-Trail.</p>
                </div>
                
                <!-- CHRONOM√àTRE -->
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 text-center">
                    <div class="text-4xl font-black text-slate-800 font-mono mb-4" id="chrono-display">00:00</div>
                    <div class="flex justify-center gap-4">
                        <button onclick="toggleChrono()" id="chrono-btn" class="bg-blue-600 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg active:scale-95 transition-all">
                            <i data-lucide="play" class="w-6 h-6 fill-current"></i>
                        </button>
                        <button onclick="resetChrono()" class="bg-slate-100 text-slate-500 w-14 h-14 rounded-full flex items-center justify-center hover:bg-slate-200 active:scale-95 transition-all">
                            <i data-lucide="rotate-ccw" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>

                <div id="ppg-list" class="space-y-3"></div>
                <button onclick="resetPPG()" class="w-full py-3 text-xs font-bold text-slate-400 uppercase tracking-widest mt-4 active:bg-slate-200 rounded-xl transition-colors">R√©initialiser la s√©ance</button>
            </div>

            <!-- MATOS TAB -->
            <div id="tab-gear" class="tab-content space-y-3">
                <!-- Simulateur de Sac V2 -->
                <div class="bg-blue-600 p-5 rounded-3xl shadow-lg text-white mb-6 relative overflow-hidden transition-all duration-500">
                    <div class="absolute -right-6 -top-6 opacity-10 rotate-12"><i data-lucide="backpack" class="w-40 h-40 text-white"></i></div>
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2 relative z-10"><i data-lucide="calculator" class="w-5 h-5"></i> Pack Simulator</h3>
                    <div class="relative z-10">
                        <div class="flex justify-between items-end mb-2"><label class="text-[10px] font-bold uppercase text-blue-200">Dur√©e sortie</label><span id="sim-duration-display" class="font-black text-2xl">2h</span></div>
                        <input type="range" id="sim-duration" min="1" max="10" step="0.5" value="2" class="w-full h-2 bg-blue-400 rounded-lg appearance-none cursor-pointer accent-white mb-6">
                        <div class="flex gap-2 mb-4">
                            <button onclick="setWeather('soleil')" id="btn-soleil" class="weather-btn flex-1 bg-blue-500/50 hover:bg-blue-500 p-2 rounded-xl text-xs font-bold flex flex-col items-center gap-1 transition-all border border-transparent"><i data-lucide="sun" class="w-5 h-5"></i> Soleil</button>
                            <button onclick="setWeather('pluie')" id="btn-pluie" class="weather-btn flex-1 bg-blue-500/50 hover:bg-blue-500 p-2 rounded-xl text-xs font-bold flex flex-col items-center gap-1 transition-all border border-transparent"><i data-lucide="cloud-rain" class="w-5 h-5"></i> Pluie</button>
                            <button onclick="setWeather('froid')" id="btn-froid" class="weather-btn flex-1 bg-blue-500/50 hover:bg-blue-500 p-2 rounded-xl text-xs font-bold flex flex-col items-center gap-1 transition-all border border-transparent"><i data-lucide="thermometer" class="w-5 h-5"></i> Froid</button>
                        </div>
                        <div class="bg-white/10 backdrop-blur-md p-4 rounded-2xl border border-white/20">
                            <div class="flex justify-between items-center mb-3">
                                <p class="text-[10px] text-blue-100 font-bold uppercase">Checklist (<span id="sim-weight-display">75</span>kg)</p>
                                <button onclick="updateSim()" class="text-[10px] text-blue-200 hover:text-white uppercase font-bold flex items-center gap-1"><i data-lucide="rotate-ccw" class="w-3 h-3"></i> Reset</button>
                            </div>
                            <div id="sim-list" class="space-y-2"></div>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <!-- Navigation -->
        <nav class="fixed bottom-6 left-6 right-6 bg-white/95 backdrop-blur-xl border border-slate-200 rounded-3xl shadow-2xl p-2 flex justify-around items-center z-40">
            <button onclick="switchTab('dashboard')" class="nav-btn active flex-1 flex flex-col items-center py-2 text-blue-600 transition-colors">
                <i data-lucide="trending-up" class="w-5 h-5"></i>
                <span class="text-[9px] font-black uppercase mt-1">Stats</span>
            </button>
            <button onclick="switchTab('journal')" class="nav-btn flex-1 flex flex-col items-center py-2 text-slate-400 hover:text-slate-600 transition-colors">
                <i data-lucide="activity" class="w-5 h-5"></i>
                <span class="text-[9px] font-black uppercase mt-1">Journal</span>
            </button>
            <!-- NOUVEAU BOUTON PROGRAMME -->
            <button onclick="switchTab('program')" class="nav-btn flex-1 flex flex-col items-center py-2 text-slate-400 hover:text-slate-600 transition-colors">
                <i data-lucide="list-checks" class="w-5 h-5"></i>
                <span class="text-[9px] font-black uppercase mt-1">Plan</span>
            </button>
            <button onclick="switchTab('ppg')" class="nav-btn flex-1 flex flex-col items-center py-2 text-slate-400 hover:text-slate-600 transition-colors">
                <i data-lucide="shield" class="w-5 h-5"></i>
                <span class="text-[9px] font-black uppercase mt-1">PPG</span>
            </button>
            <button onclick="switchTab('gear')" class="nav-btn flex-1 flex flex-col items-center py-2 text-slate-400 hover:text-slate-600 transition-colors">
                <i data-lucide="package" class="w-5 h-5"></i>
                <span class="text-[9px] font-black uppercase mt-1">Matos</span>
            </button>
        </nav>
    </div>

    <!-- Modal R√©glages -->
    <div id="settings-modal" class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
            <h3 class="text-xl font-black mb-4">R√©glages</h3>
            <div class="bg-slate-50 p-4 rounded-xl mb-4 border border-slate-100">
                <h4 class="text-sm font-bold text-slate-800 mb-2">Profil Athl√®te</h4>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-[10px] uppercase text-slate-400 font-bold">Poids (kg)</label><input type="number" id="user-weight" class="w-full p-2 rounded-lg border text-sm font-bold" placeholder="Ex: 75"></div>
                    <div><label class="text-[10px] uppercase text-slate-400 font-bold">Taille (cm)</label><input type="number" id="user-height" class="w-full p-2 rounded-lg border text-sm font-bold" placeholder="Ex: 180"></div>
                </div>
                <button onclick="saveProfile()" class="w-full mt-3 bg-slate-800 text-white py-2 rounded-lg text-xs font-bold uppercase">Sauvegarder Profil</button>
            </div>
            
            <hr class="border-slate-100 my-4">
            
            <button onclick="logout()" class="w-full bg-red-50 text-red-600 font-bold py-3 rounded-xl border border-red-100 hover:bg-red-100 flex items-center justify-center gap-2">
                <i data-lucide="log-out" class="w-4 h-4"></i> Se d√©connecter
            </button>
            
            <button onclick="closeSettings()" class="w-full mt-2 text-slate-400 font-bold py-3 rounded-xl hover:bg-slate-50">Fermer</button>
        </div>
    </div>

    <!-- Modal Ajout/Modif S√©ance -->
    <div id="add-modal" class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm hidden flex items-end sm:items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl animate-[fadeIn_0.3s_ease-out]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black" id="modal-title">Ajouter S√©ance</h3>
                <button onclick="closeModal()" class="p-2 bg-slate-100 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="add-form" class="space-y-4">
                <input type="hidden" name="id" id="session-id">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="space-y-1"><label class="text-[10px] font-bold uppercase text-slate-400">Date</label><input name="date" type="date" required class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold border border-slate-100 outline-none focus:border-blue-500" id="date-input"></div>
                    <div class="space-y-1"><label class="text-[10px] font-bold uppercase text-slate-400">Type</label><select name="type" id="type-input" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold border border-slate-100 outline-none focus:border-blue-500"><option>EF (Footing)</option><option>Sortie Longue</option><option>Trail / D+</option><option>VMA / Seuil</option><option>PPG Seule</option></select></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1"><label class="text-[10px] font-bold uppercase text-slate-400">Dist. (km)</label><input name="km" id="km-input" type="number" step="0.1" placeholder="0.0" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold border border-slate-100 outline-none focus:border-blue-500"></div>
                    <div class="space-y-1"><label class="text-[10px] font-bold uppercase text-slate-400">D+ (m)</label><input name="dPlus" id="dplus-input" type="number" placeholder="0" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold border border-slate-100 outline-none focus:border-blue-500"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold uppercase text-slate-400">Dur√©e (H:M:S)</label>
                        <div class="flex gap-2">
                            <input name="dur_h" id="dur-h" type="number" placeholder="H" min="0" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold border border-slate-100 outline-none focus:border-blue-500 time-input">
                            <input name="dur_m" id="dur-m" type="number" placeholder="M" min="0" max="59" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold border border-slate-100 outline-none focus:border-blue-500 time-input">
                            <input name="dur_s" id="dur-s" type="number" placeholder="S" min="0" max="59" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold border border-slate-100 outline-none focus:border-blue-500 time-input">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                         <div class="space-y-1"><label class="text-[10px] font-bold uppercase text-slate-400">FC Moy</label><input name="avgHr" id="fc-input" type="number" placeholder="BPM" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold border border-slate-100 outline-none focus:border-blue-500 text-center"></div>
                        <div class="space-y-1"><label class="text-[10px] font-bold uppercase text-slate-400">RPE</label><input name="rpe" id="rpe-input" type="number" min="1" max="10" placeholder="1-10" required class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold border border-slate-100 outline-none focus:border-blue-500 text-center"></div>
                    </div>
                </div>
                
                <!-- Zone de commentaire ajout√©e -->
                <div class="space-y-1">
                    <label class="text-[10px] font-bold uppercase text-slate-400">Notes & Sensations</label>
                    <textarea name="notes" id="notes-input" rows="2" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-medium border border-slate-100 outline-none focus:border-blue-500 resize-none" placeholder="Sensations, m√©t√©o, mat√©riel..."></textarea>
                </div>

                <div class="flex items-center gap-3 bg-slate-50 p-3 rounded-xl border border-slate-100">
                    <input type="checkbox" name="ppg" id="ppg-check" class="w-5 h-5 accent-blue-600 rounded"><label htmlFor="ppg-check" class="text-sm font-bold text-slate-600">Session PPG incluse ?</label>
                </div>
                <button type="submit" id="submit-btn" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-500/20 active:scale-95 transition-all">ENREGISTRER</button>
            </form>
        </div>
    </div>

    <!-- ======================================================= -->
    <!-- LOGIQUE JAVASCRIPT AVEC FIREBASE                        -->
    <!-- ======================================================= -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, deleteDoc, doc, updateDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // =========================================================================
        // üî¥ CONFIGURATION FIREBASE (TES CL√âS SONT ICI) üî¥
        // =========================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyByuABj8lDBXQWQI_V-Gsk-iN4XwbNk5UI",
            authDomain: "road-to-gt85.firebaseapp.com",
            projectId: "road-to-gt85",
            storageBucket: "road-to-gt85.firebasestorage.app",
            messagingSenderId: "337729038344",
            appId: "1:337729038344:web:37c9b098976b67558cc9bd",
            measurementId: "G-3RZFR8H9CN"
        };
        // =========================================================================

        const PPG_EXERCISES = [
            { id: 'chaise', name: "Chaise (Mur)", info: "4x45s ‚Ä¢ Cuisses" },
            { id: 'squat', name: "Squats", info: "3x20 ‚Ä¢ Puissance" },
            { id: 'fentes', name: "Fentes", info: "3x12/j ‚Ä¢ Stabilit√©" },
            { id: 'gainage', name: "Gainage", info: "4x1min ‚Ä¢ Tronc" },
            { id: 'proprio', name: "Proprioception", info: "3x30s ‚Ä¢ Chevilles" }
        ];

        // --- Initialisation ---
        let app, db, auth, userId;
        let weeklyChart = null;
        let allSessionsData = []; 
        let currentCalendarDate = new Date();

        function initApp() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Observer l'√©tat de connexion
                onAuthStateChanged(auth, (user) => {
                    document.getElementById('loading').style.display = 'none';
                    
                    if (user) {
                        // User connect√©
                        userId = user.uid;
                        document.getElementById('auth-container').classList.add('hidden');
                        document.getElementById('app-container').classList.remove('hidden');
                        
                        // Charger profil local
                        document.getElementById('user-weight').value = localStorage.getItem('gt85_weight') || '';
                        document.getElementById('user-height').value = localStorage.getItem('gt85_height') || '';
                        
                        // D√©marrer les √©couteurs de donn√©es
                        initDataListeners();
                    } else {
                        // User d√©connect√©
                        document.getElementById('app-container').classList.add('hidden');
                        document.getElementById('auth-container').classList.remove('hidden');
                    }
                });

            } catch (e) {
                console.error("Erreur Init:", e);
                alert("Erreur: " + e.message);
            }
        }

        // --- AUTHENTIFICATION ---
        
        let isLoginMode = true;

        window.toggleAuthMode = () => {
            isLoginMode = !isLoginMode;
            const title = document.getElementById('auth-subtitle');
            const btn = document.getElementById('btn-auth-submit');
            const toggle = document.getElementById('btn-toggle-mode');
            const errorDiv = document.getElementById('auth-error');
            
            errorDiv.classList.add('hidden');
            
            if(isLoginMode) {
                title.innerText = "Connexion";
                btn.innerText = "SE CONNECTER";
                toggle.innerText = "Pas de compte ? Cr√©er un compte";
            } else {
                title.innerText = "Inscription";
                btn.innerText = "CR√âER UN COMPTE";
                toggle.innerText = "D√©j√† un compte ? Se connecter";
            }
        }

        window.handleAuth = async (e) => {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const errorDiv = document.getElementById('auth-error');
            
            errorDiv.classList.add('hidden');
            errorDiv.innerText = "";

            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    if(password.length < 6) throw new Error("Le mot de passe doit faire 6 caract√®res minimum.");
                    await createUserWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                console.error(error);
                let msg = error.message;
                // Traduction basique des erreurs fr√©quentes
                if(msg.includes('auth/invalid-email')) msg = "Email invalide.";
                if(msg.includes('auth/user-not-found')) msg = "Utilisateur inconnu.";
                if(msg.includes('auth/wrong-password')) msg = "Mot de passe incorrect.";
                if(msg.includes('auth/email-already-in-use')) msg = "Cet email est d√©j√† utilis√©.";
                if(msg.includes('auth/weak-password')) msg = "Mot de passe trop faible (6 car. min).";
                
                errorDiv.innerText = msg;
                errorDiv.classList.remove('hidden');
            }
        }

        window.logout = async () => {
            if(confirm("Se d√©connecter ?")) {
                await signOut(auth);
                window.location.reload();
            }
        }

        document.getElementById('auth-form').addEventListener('submit', window.handleAuth);

        // --- Logique Application ---

        function initDataListeners() {
            const qSessions = query(collection(db, `users/${userId}/sessions`), orderBy("date", "desc"));
            onSnapshot(qSessions, (snapshot) => {
                const sessions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allSessionsData = sessions;
                
                renderSessions(sessions);
                calculateStats(sessions);
                renderChart(sessions);
                renderCalendar();
            }, (error) => {
                console.error("Erreur Data:", error);
            });

            const qPPG = collection(db, `users/${userId}/ppg_status`);
            onSnapshot(qPPG, (snapshot) => {
                const ppgStatus = {};
                snapshot.docs.forEach(doc => ppgStatus[doc.id] = doc.data().done);
                renderPPG(ppgStatus);
            });
        }

        // --- Calendrier Logic ---
        window.changeMonth = (delta) => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderCalendar();
        }

        function renderCalendar() {
            const container = document.getElementById('calendar-days');
            const monthLabel = document.getElementById('calendar-month-year');
            if(!container) return;
            
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const monthNames = ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"];
            monthLabel.innerText = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            let startDayIndex = firstDay.getDay() - 1;
            if (startDayIndex === -1) startDayIndex = 6;
            
            const totalDays = lastDay.getDate();
            container.innerHTML = '';
            
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;

            // Map sessions
            const sessionDates = {};
            allSessionsData.forEach(s => {
                const sDate = new Date(s.date);
                if(sDate.getFullYear() === year && sDate.getMonth() === month) {
                    const d = sDate.getDate();
                    if(!sessionDates[d]) sessionDates[d] = [];
                    sessionDates[d].push(s);
                }
            });

            // Padding
            for(let i=0; i<startDayIndex; i++) {
                const cell = document.createElement('div');
                cell.className = "calendar-day bg-transparent";
                container.appendChild(cell);
            }

            // Days
            for(let i=1; i<=totalDays; i++) {
                const cell = document.createElement('div');
                cell.className = "calendar-day bg-slate-50";
                cell.innerText = i;
                
                if(isCurrentMonth && i === today.getDate()) cell.classList.add('today');
                
                if(sessionDates[i]) {
                    const totalKm = sessionDates[i].reduce((acc, s) => acc + (s.km || 0), 0);
                    cell.classList.add('has-run');
                    if(totalKm > 15) cell.style.backgroundColor = '#1e3a8a';
                    else if(totalKm > 8) cell.style.backgroundColor = '#2563eb';
                    else cell.style.backgroundColor = '#93c5fd';
                }
                container.appendChild(cell);
            }
        }

        // --- Gestion des S√©ances ---
        async function handleSessionSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const sessionId = formData.get('id');

            const h = formData.get('dur_h') || '0';
            const m = (formData.get('dur_m') || '0').toString().padStart(2, '0');
            const s = (formData.get('dur_s') || '0').toString().padStart(2, '0');
            const formattedDuration = `${h}:${m}:${s}`;
            const cleanDuration = formattedDuration === "0:00:00" ? "--:--" : (h === "0" ? `${m}:${s}` : formattedDuration);

            const sessionData = {
                date: formData.get('date'),
                type: formData.get('type'),
                km: parseFloat(formData.get('km') || 0),
                dPlus: parseInt(formData.get('dPlus') || 0),
                duration: cleanDuration,
                avgHr: parseInt(formData.get('avgHr') || 0),
                rpe: parseInt(formData.get('rpe') || 0),
                ppg: formData.get('ppg') === 'on',
                notes: formData.get('notes') || '',
                timestamp: new Date()
            };

            try {
                if (sessionId) {
                    await updateDoc(doc(db, `users/${userId}/sessions`, sessionId), sessionData);
                } else {
                    await addDoc(collection(db, `users/${userId}/sessions`), sessionData);
                }
                closeModal();
                e.target.reset();
            } catch (err) {
                console.error("Erreur sauvegarde:", err);
                alert("Erreur: " + err.message);
            }
        }

        window.deleteSession = async (id) => {
            if(confirm('Supprimer cette s√©ance ?')) {
                await deleteDoc(doc(db, `users/${userId}/sessions`, id));
            }
        }

        window.editSession = async (id) => {
            const docSnap = await getDoc(doc(db, `users/${userId}/sessions`, id));
            if (docSnap.exists()) {
                const data = docSnap.data();
                openModal(true);
                document.getElementById('session-id').value = id;
                document.getElementById('date-input').value = data.date;
                document.getElementById('type-input').value = data.type;
                document.getElementById('km-input').value = data.km;
                document.getElementById('dplus-input').value = data.dPlus;
                document.getElementById('fc-input').value = data.avgHr || '';
                document.getElementById('rpe-input').value = data.rpe;
                document.getElementById('notes-input').value = data.notes || '';
                document.getElementById('ppg-check').checked = data.ppg;

                if(data.duration && data.duration !== "--:--") {
                    const parts = data.duration.split(':');
                    if(parts.length === 3) {
                        document.getElementById('dur-h').value = parts[0];
                        document.getElementById('dur-m').value = parts[1];
                        document.getElementById('dur-s').value = parts[2];
                    } else if (parts.length === 2) {
                        document.getElementById('dur-h').value = 0;
                        document.getElementById('dur-m').value = parts[0];
                        document.getElementById('dur-s').value = parts[1];
                    }
                } else {
                    document.getElementById('dur-h').value = '';
                    document.getElementById('dur-m').value = '';
                    document.getElementById('dur-s').value = '';
                }
            }
        }

        // --- PPG / Chrono ---
        window.togglePPG = async (id, status) => {
            await setDoc(doc(db, `users/${userId}/ppg_status`, id), { done: status }, { merge: true });
        }
        
        window.resetPPG = async () => {
             PPG_EXERCISES.forEach(async (ex) => {
                 await setDoc(doc(db, `users/${userId}/ppg_status`, ex.id), { done: false });
             });
        }

        let chronoInterval;
        let chronoTime = 0;
        let chronoRunning = false;

        window.toggleChrono = () => {
            const btn = document.getElementById('chrono-btn');
            if (chronoRunning) {
                clearInterval(chronoInterval);
                chronoRunning = false;
                btn.classList.remove('bg-amber-500');
                btn.classList.add('bg-blue-600');
                btn.innerHTML = '<i data-lucide="play" class="w-6 h-6 fill-current"></i>';
            } else {
                chronoInterval = setInterval(() => {
                    chronoTime++;
                    const m = Math.floor(chronoTime / 60).toString().padStart(2, '0');
                    const s = (chronoTime % 60).toString().padStart(2, '0');
                    document.getElementById('chrono-display').innerText = `${m}:${s}`;
                }, 1000);
                chronoRunning = true;
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-amber-500');
                btn.innerHTML = '<i data-lucide="pause" class="w-6 h-6 fill-current"></i>';
            }
            lucide.createIcons();
        }

        window.resetChrono = () => {
            clearInterval(chronoInterval);
            chronoRunning = false;
            chronoTime = 0;
            document.getElementById('chrono-display').innerText = `00:00`;
            const btn = document.getElementById('chrono-btn');
            btn.classList.remove('bg-amber-500');
            btn.classList.add('bg-blue-600');
            btn.innerHTML = '<i data-lucide="play" class="w-6 h-6 fill-current"></i>';
            lucide.createIcons();
        }

        // --- Helpers ---
        window.openSettings = () => { document.getElementById('settings-modal').classList.remove('hidden'); }
        window.closeSettings = () => { document.getElementById('settings-modal').classList.add('hidden'); }
        window.saveProfile = () => {
            localStorage.setItem('gt85_weight', document.getElementById('user-weight').value);
            localStorage.setItem('gt85_height', document.getElementById('user-height').value);
            alert("Profil sauvegard√© !");
            window.location.reload();
        }

        // --- UI Logic ---
        window.toggleDetails = (id) => {
            const el = document.getElementById('details-' + id);
            const icon = document.getElementById('chevron-' + id);
            
            if (el.classList.contains('hidden')) {
                el.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
            } else {
                el.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // --- Render Functions ---
        function renderSessions(sessions) {
            const container = document.getElementById('sessions-list');
            container.innerHTML = '';
            if(sessions.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-400 py-10 italic">Aucune s√©ance.</p>';
                return;
            }
            sessions.forEach(s => {
                const ratio = s.km > 0 ? Math.round(s.dPlus / s.km) : 0;
                let ratioColor = "text-slate-400";
                if (ratio > 30) ratioColor = "text-blue-500";
                if (ratio > 38) ratioColor = "text-emerald-600 font-black";

                let pace = "--:--";
                if (s.km > 0 && s.duration && s.duration !== "--:--") {
                    const parts = s.duration.split(':').map(Number);
                    let totalMin = 0;
                    if (parts.length === 3) totalMin = parts[0] * 60 + parts[1] + parts[2] / 60;
                    else if (parts.length === 2) totalMin = parts[0] + parts[1] / 60;
                    if (totalMin > 0) {
                        const minPerKm = totalMin / s.km;
                        const pMin = Math.floor(minPerKm);
                        const pSec = Math.round((minPerKm - pMin) * 60);
                        pace = `${pMin}:${pSec.toString().padStart(2, '0')}`;
                    }
                }

                let hrColor = 'text-slate-400';
                if (s.avgHr < 130) hrColor = 'text-slate-500';
                else if (s.avgHr < 145) hrColor = 'text-emerald-500';
                else if (s.avgHr < 160) hrColor = 'text-yellow-500';
                else if (s.avgHr < 175) hrColor = 'text-orange-500';
                else if (s.avgHr >= 175) hrColor = 'text-red-500';

                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex items-center justify-between";
                div.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-[10px] font-bold text-blue-500 uppercase bg-blue-50 px-2 py-0.5 rounded">${new Date(s.date).toLocaleDateString('fr-FR', {day: '2-digit', month: '2-digit'})}</span>
                            <span class="text-xs font-bold text-slate-700">${s.type}</span>
                        </div>
                        <div class="flex gap-3 text-sm font-black text-slate-800">
                           <span>${s.km} km</span><span class="text-slate-300">|</span><span>${s.dPlus} m D+</span>
                        </div>
                        <div class="flex gap-3 text-xs font-medium mt-1 items-center flex-wrap">
                           <span class="text-slate-500 flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> ${s.duration}</span>
                           ${s.avgHr > 0 ? `<span class="${hrColor} flex items-center gap-1"><i data-lucide="heart" class="w-3 h-3"></i> ${s.avgHr}</span>` : ''}
                           <span class="${ratioColor} ml-2 border-l pl-2 border-slate-200">Ratio: ${ratio}m/km</span>
                           <span class="text-slate-400 ml-2 border-l pl-2 border-slate-200 font-mono text-[10px]">Allure: ${pace}/km</span>
                        </div>
                        ${s.notes ? `<p class="text-xs text-slate-500 italic mt-2 bg-slate-50 p-2 rounded-lg border border-slate-100 line-clamp-2">${s.notes}</p>` : ''}
                        ${s.ppg ? '<span class="text-[9px] text-emerald-600 font-bold flex items-center gap-1 mt-1"><i data-lucide="check-circle-2" class="w-3 h-3"></i> PPG INCLUSE</span>' : ''}
                    </div>
                    <div class="flex flex-col gap-1">
                        <button onclick="editSession('${s.id}')" class="text-slate-300 hover:text-blue-500 p-2"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                        <button onclick="deleteSession('${s.id}')" class="text-slate-300 hover:text-red-500 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });
            lucide.createIcons();
        }

        function calculateStats(sessions) {
            const totalKm = sessions.reduce((acc, s) => acc + (parseFloat(s.km) || 0), 0);
            const totalDPlus = sessions.reduce((acc, s) => acc + (parseInt(s.dPlus) || 0), 0);
            document.getElementById('stat-km').innerText = totalKm.toFixed(1);
            document.getElementById('stat-dplus').innerText = totalDPlus;

            const now = new Date();
            const dayOfWeek = now.getDay(); 
            const distToMonday = (dayOfWeek + 6) % 7; 
            const thisMonday = new Date(now);
            thisMonday.setDate(now.getDate() - distToMonday);
            thisMonday.setHours(0,0,0,0);
            const nextMonday = new Date(thisMonday);
            nextMonday.setDate(thisMonday.getDate() + 7);
            const lastMonday = new Date(thisMonday);
            lastMonday.setDate(thisMonday.getDate() - 7);

            let currentWeekKm = 0, currentWeekDplus = 0;
            let lastWeekKm = 0, lastWeekDplus = 0;

            sessions.forEach(s => {
                const parts = s.date.split('-');
                const sDate = new Date(parts[0], parts[1]-1, parts[2]); 
                if (sDate >= thisMonday && sDate < nextMonday) {
                    currentWeekKm += (parseFloat(s.km) || 0);
                    currentWeekDplus += (parseInt(s.dPlus) || 0);
                } else if (sDate >= lastMonday && sDate < thisMonday) {
                    lastWeekKm += (parseFloat(s.km) || 0);
                    lastWeekDplus += (parseInt(s.dPlus) || 0);
                }
            });

            document.getElementById('current-week-km').innerText = currentWeekKm.toFixed(1);
            document.getElementById('current-week-dplus').innerText = currentWeekDplus;
            document.getElementById('last-week-km').innerText = lastWeekKm.toFixed(1);
            document.getElementById('last-week-dplus').innerText = lastWeekDplus;
        }

        function renderChart(sessions) {
            const ctx = document.getElementById('weeklyChart');
            if(!ctx) return;
            if (sessions.length === 0) return;

            const sorted = [...sessions].sort((a, b) => new Date(a.date) - new Date(b.date));
            const firstDate = new Date(sorted[0].date);
            const day = firstDate.getDay();
            const diff = firstDate.getDate() - day + (day === 0 ? -6 : 1); 
            const startOfPlan = new Date(firstDate.setDate(diff));
            startOfPlan.setHours(0,0,0,0);

            const weeks = {};
            let maxWeekNum = 0;

            sessions.forEach(s => {
                const d = new Date(s.date);
                d.setHours(0,0,0,0);
                const diffTime = d - startOfPlan;
                const weekNum = Math.floor(diffTime / (1000 * 60 * 60 * 24 * 7)) + 1;
                if (weekNum > 0) {
                    const key = `S${weekNum}`;
                    if(!weeks[key]) weeks[key] = 0;
                    weeks[key] += parseFloat(s.km);
                    if (weekNum > maxWeekNum) maxWeekNum = weekNum;
                }
            });

            const labels = [];
            const data = [];
            for(let i = 1; i <= maxWeekNum; i++) {
                labels.push(`S${i}`);
                data.push(weeks[`S${i}`] || 0);
            }

            if (weeklyChart) weeklyChart.destroy();

            weeklyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Volume (km)',
                        data: data,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#2563eb',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { font: { size: 10 } } },
                        x: { grid: { display: false }, ticks: { font: { size: 10 } } }
                    }
                }
            });
        }

        function renderPPG(statusMap) {
            const container = document.getElementById('ppg-list');
            container.innerHTML = '';
            PPG_EXERCISES.forEach(ex => {
                const isDone = statusMap[ex.id] === true;
                const div = document.createElement('div');
                div.className = `p-4 rounded-2xl border cursor-pointer flex justify-between items-center transition-all ${isDone ? 'bg-emerald-50 border-emerald-200' : 'bg-white border-slate-100'}`;
                div.onclick = () => togglePPG(ex.id, !isDone);
                div.innerHTML = `
                    <div>
                        <h4 class="font-bold ${isDone ? 'text-emerald-700 line-through' : 'text-slate-800'}">${ex.name}</h4>
                        <p class="text-xs text-slate-500">${ex.info}</p>
                    </div>
                    <div class="${isDone ? 'text-emerald-500' : 'text-slate-200'}">
                        <i data-lucide="check-circle-2" class="w-6 h-6"></i>
                    </div>
                `;
                container.appendChild(div);
            });
            lucide.createIcons();
        }

        // --- Simulateur Sac ---
        let currentSimWeather = 'soleil'; 

        window.setWeather = (weather) => {
            currentSimWeather = weather;
            document.querySelectorAll('.weather-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'text-blue-600', 'scale-105', 'shadow-lg');
                btn.classList.add('bg-blue-500/50', 'text-white');
            });
            const activeBtn = document.getElementById('btn-' + weather);
            activeBtn.classList.remove('bg-blue-500/50', 'text-white');
            activeBtn.classList.add('bg-white', 'text-blue-600', 'scale-105', 'shadow-lg');
            updateSim();
        }

        function initSimulator() {
            const weight = parseFloat(localStorage.getItem('gt85_weight')) || 75;
            document.getElementById('sim-weight-display').innerText = weight;
            const slider = document.getElementById('sim-duration');
            slider.addEventListener('input', updateSim);
            window.setWeather('soleil');
        }

        window.updateSim = () => {
            const slider = document.getElementById('sim-duration');
            const h = parseFloat(slider.value);
            document.getElementById('sim-duration-display').innerText = h + 'h';
            
            // Recupere le poids stock√© OU 75 par d√©faut
            const storedWeight = localStorage.getItem('gt85_weight');
            const weight = parseFloat(storedWeight) || 75;
            
            // Met √† jour le texte du titre (ex: Checklist (82kg))
            const weightDisplay = document.getElementById('sim-weight-display');
            if(weightDisplay) weightDisplay.innerText = weight;

            const ratio = weight / 75;
            const water = (h * 0.5 * ratio).toFixed(1);
            const carbs = Math.round(h * 60 * ratio);
            
            let items = [
                { name: `${water}L Eau / Iso`, icon: 'droplet' },
                { name: `${carbs}g Glucides`, icon: 'cookie' },
                { name: 'T√©l√©phone charg√©', icon: 'smartphone' }
            ];

            if (h >= 3) items.push({ name: 'Kit Survie (Sifflet/Couv.)', icon: 'shield-alert' });
            if (h >= 4) items.push({ name: 'B√¢tons', icon: 'move-vertical' });
            if (h >= 5) items.push({ name: 'Frontale + Batterie', icon: 'flashlight' });

            if (currentSimWeather === 'pluie') {
                items.push({ name: 'Veste Membrane', icon: 'umbrella' });
                items.push({ name: 'Casquette Pluie', icon: 'shield' });
            } else if (currentSimWeather === 'froid') {
                items.push({ name: 'Gants & Bonnet', icon: 'thermometer' });
                items.push({ name: 'Veste Thermique', icon: 'shirt' });
            } else if (currentSimWeather === 'soleil') {
                items.push({ name: 'Lunettes & Cr√®me', icon: 'sun' });
                items.push({ name: 'Casquette', icon: 'glasses' });
            }

            renderSimList(items);
        }

        function renderSimList(items) {
            const container = document.getElementById('sim-list');
            container.innerHTML = '';
            items.forEach(item => {
                const label = document.createElement('label');
                label.className = "flex items-center gap-3 cursor-pointer group select-none bg-white/5 p-2 rounded-xl hover:bg-white/10 transition-colors";
                label.innerHTML = `
                    <div class="relative flex-shrink-0">
                        <input type="checkbox" class="peer sr-only sim-check">
                        <div class="w-6 h-6 border-2 border-white rounded-lg peer-checked:bg-white transition-all flex items-center justify-center">
                            <i data-lucide="check" class="w-4 h-4 text-blue-600 opacity-0 peer-checked:opacity-100 transition-opacity"></i>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <i data-lucide="${item.icon}" class="w-5 h-5 text-blue-200"></i>
                        <span class="font-bold text-sm">${item.name}</span>
                    </div>
                `;
                container.appendChild(label);
            });
            lucide.createIcons();
        }

        document.getElementById('add-form').addEventListener('submit', handleSessionSubmit);
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            initSimulator();
        });

        // Tabs Logic
        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => {
                el.classList.remove('text-blue-600', 'active');
                el.classList.add('text-slate-400');
            });
            document.getElementById('tab-' + tabId).classList.add('active');
            const activeBtn = document.querySelector(`button[onclick="switchTab('${tabId}')"]`);
            if(activeBtn) {
                activeBtn.classList.remove('text-slate-400');
                activeBtn.classList.add('text-blue-600', 'active');
            }
        }

        // Modal Logic
        window.openModal = (isEdit = false) => {
            document.getElementById('add-modal').classList.remove('hidden');
            if(!isEdit) {
                document.getElementById('add-form').reset();
                document.getElementById('session-id').value = "";
                document.getElementById('modal-title').innerText = "Ajouter S√©ance";
                document.getElementById('submit-btn').innerText = "ENREGISTRER";
                document.getElementById('submit-btn').classList.remove('bg-emerald-600');
                document.getElementById('submit-btn').classList.add('bg-blue-600');
                document.getElementById('date-input').valueAsDate = new Date();
            } else {
                document.getElementById('modal-title').innerText = "Modifier S√©ance";
                document.getElementById('submit-btn').innerText = "METTRE √Ä JOUR";
                document.getElementById('submit-btn').classList.remove('bg-blue-600');
                document.getElementById('submit-btn').classList.add('bg-emerald-600');
            }
        }
        window.closeModal = () => { document.getElementById('add-modal').classList.add('hidden'); }

        // Init Icons
        lucide.createIcons();
    </script>
</body>
</html>