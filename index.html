<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Road to GT85 - Cloud</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Recharts -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loading-screen { position: fixed; inset: 0; background: white; z-index: 50; display: flex; align-items: center; justify-content: center; }
        
        /* Masquer la scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-24 select-none">

    <!-- Écran de chargement -->
    <div id="loading" class="loading-screen">
        <div class="text-center">
            <h1 class="text-3xl font-black italic mb-2">GT85</h1>
            <p class="text-slate-400 text-sm animate-pulse">Connexion Cloud...</p>
        </div>
    </div>

    <!-- En-tête -->
    <header class="px-6 pt-8 pb-4 bg-white shadow-sm sticky top-0 z-30">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-black italic tracking-tighter uppercase">Road to <span class="text-blue-600">GT85</span></h1>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em]">Base de Données Active</p>
            </div>
            <!-- Bouton Réglages / Synchro -->
            <button onclick="openSettings()" class="bg-slate-100 p-2 rounded-full text-slate-600 hover:bg-slate-200 transition-colors">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- Contenu Principal -->
    <main class="px-4 mt-4">
        
        <!-- DASHBOARD TAB -->
        <div id="tab-dashboard" class="tab-content active space-y-6">
            <!-- Stats Cards -->
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                    <p class="text-[10px] text-blue-600 font-bold uppercase">Distance Totale</p>
                    <p class="text-2xl font-black text-blue-900"><span id="stat-km">0</span> <span class="text-xs">km</span></p>
                </div>
                <div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-100">
                    <p class="text-[10px] text-emerald-600 font-bold uppercase">Dénivelé Total</p>
                    <p class="text-2xl font-black text-emerald-900"><span id="stat-dplus">0</span> <span class="text-xs">m</span></p>
                </div>
                <div class="bg-amber-50 p-4 rounded-2xl border border-amber-100">
                    <p class="text-[10px] text-amber-600 font-bold uppercase">Moyenne RPE</p>
                    <p class="text-2xl font-black text-amber-900"><span id="stat-rpe">0</span><span class="text-xs">/10</span></p>
                </div>
                <div class="bg-slate-100 p-4 rounded-2xl border border-slate-200">
                    <p class="text-[10px] text-slate-500 font-bold uppercase">Sessions PPG</p>
                    <p class="text-2xl font-black text-slate-800"><span id="stat-ppg">0</span></p>
                </div>
            </div>

            <!-- Résumés Hebdomadaires -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <!-- Semaine Dernière -->
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="font-bold text-slate-800 mb-2 flex items-center gap-2 text-xs uppercase text-slate-400 tracking-wider">
                        <i data-lucide="calendar-check-2" class="w-4 h-4"></i> Semaine Dernière
                    </h3>
                    <div class="flex justify-between items-end">
                        <div>
                            <span class="text-3xl font-black text-slate-800" id="last-week-km">0</span>
                            <span class="text-xs font-bold text-slate-400">km</span>
                        </div>
                        <div class="text-right">
                            <span class="text-xl font-bold text-emerald-600" id="last-week-dplus">0</span>
                            <span class="text-[10px] font-bold text-slate-400 uppercase">m D+</span>
                        </div>
                    </div>
                </div>

                <!-- Semaine En Cours -->
                <div class="bg-blue-600 p-4 rounded-2xl shadow-lg shadow-blue-200">
                    <h3 class="font-bold text-blue-100 mb-2 flex items-center gap-2 text-xs uppercase tracking-wider">
                        <i data-lucide="calendar-clock" class="w-4 h-4"></i> Semaine en cours
                    </h3>
                    <div class="flex justify-between items-end text-white">
                        <div>
                            <span class="text-3xl font-black" id="current-week-km">0</span>
                            <span class="text-xs font-bold text-blue-200">km</span>
                        </div>
                        <div class="text-right">
                            <span class="text-xl font-bold" id="current-week-dplus">0</span>
                            <span class="text-[10px] font-bold text-blue-200 uppercase">m D+</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- JOURNAL TAB -->
        <div id="tab-journal" class="tab-content space-y-4">
            <div class="flex justify-between items-center px-1">
                <h2 class="text-xl font-black text-slate-800">Séances</h2>
                <button onclick="openModal()" class="bg-blue-600 text-white p-2 rounded-full shadow-lg active:scale-95 transition-transform">
                    <i data-lucide="plus" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="sessions-list" class="space-y-3 pb-20">
                <!-- Les séances seront injectées ici par JS -->
                <p class="text-center text-slate-400 py-10 italic">Chargement...</p>
            </div>
        </div>

        <!-- PPG TAB -->
        <div id="tab-ppg" class="tab-content space-y-4">
            <div class="bg-slate-900 p-6 rounded-3xl text-white shadow-xl relative overflow-hidden">
                <div class="absolute right-[-20px] bottom-[-20px] opacity-10"><i data-lucide="shield" class="w-32 h-32"></i></div>
                <h2 class="text-xl font-black mb-1">Programme "L'Armure"</h2>
                <p class="text-xs text-slate-400">Renforcement spécifique Ultra-Trail.</p>
            </div>
            <div id="ppg-list" class="space-y-3">
                <!-- JS injectera la liste ici -->
            </div>
            <button onclick="resetPPG()" class="w-full py-3 text-xs font-bold text-slate-400 uppercase tracking-widest mt-4 active:bg-slate-200 rounded-xl transition-colors">Réinitialiser la séance</button>
        </div>

        <!-- MATOS TAB -->
        <div id="tab-gear" class="tab-content space-y-3">
            <h2 class="text-xl font-black text-slate-800 px-1">Matériel & Budget</h2>
            <div id="gear-list" class="space-y-3 pb-20">
                <!-- JS injectera le matos ici -->
            </div>
        </div>

    </main>

    <!-- Navigation -->
    <nav class="fixed bottom-6 left-6 right-6 bg-white/95 backdrop-blur-xl border border-slate-200 rounded-3xl shadow-2xl p-2 flex justify-around items-center z-40">
        <button onclick="switchTab('dashboard')" class="nav-btn active flex-1 flex flex-col items-center py-2 text-blue-600 transition-colors">
            <i data-lucide="trending-up" class="w-5 h-5"></i>
            <span class="text-[9px] font-black uppercase mt-1">Stats</span>
        </button>
        <button onclick="switchTab('journal')" class="nav-btn flex-1 flex flex-col items-center py-2 text-slate-400 hover:text-slate-600 transition-colors">
            <i data-lucide="activity" class="w-5 h-5"></i>
            <span class="text-[9px] font-black uppercase mt-1">Journal</span>
        </button>
        <button onclick="switchTab('ppg')" class="nav-btn flex-1 flex flex-col items-center py-2 text-slate-400 hover:text-slate-600 transition-colors">
            <i data-lucide="shield" class="w-5 h-5"></i>
            <span class="text-[9px] font-black uppercase mt-1">PPG</span>
        </button>
        <button onclick="switchTab('gear')" class="nav-btn flex-1 flex flex-col items-center py-2 text-slate-400 hover:text-slate-600 transition-colors">
            <i data-lucide="package" class="w-5 h-5"></i>
            <span class="text-[9px] font-black uppercase mt-1">Matos</span>
        </button>
    </nav>

    <!-- Modal Réglages / Synchro -->
    <div id="settings-modal" class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <h3 class="text-xl font-black mb-4">Synchronisation</h3>
            <p class="text-sm text-slate-500 mb-4">Pour voir tes données sur un autre appareil, copie cet identifiant :</p>
            
            <div class="bg-slate-100 p-3 rounded-xl mb-4 flex items-center gap-2">
                <code id="current-user-id" class="flex-1 font-mono text-xs font-bold text-slate-700 break-all">...</code>
                <button onclick="copyId()" class="text-blue-600"><i data-lucide="copy" class="w-4 h-4"></i></button>
            </div>

            <hr class="border-slate-100 my-4">
            
            <p class="text-sm text-slate-500 mb-2">Ou colle un identifiant existant ici :</p>
            <form onsubmit="saveNewId(event)">
                <input type="text" name="newId" placeholder="Coller l'ID ici..." class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold border border-slate-200 mb-4 outline-none focus:border-blue-500">
                <div class="flex gap-2">
                    <button type="button" onclick="closeSettings()" class="flex-1 bg-slate-100 text-slate-600 font-bold py-3 rounded-xl">Fermer</button>
                    <button type="submit" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl">Charger</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Ajout Séance -->
    <div id="add-modal" class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm hidden flex items-end sm:items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl animate-[fadeIn_0.3s_ease-out]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Ajouter Séance</h3>
                <button onclick="closeModal()" class="p-2 bg-slate-100 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="add-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold uppercase text-slate-400">Date</label>
                        <input name="date" type="date" required class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold border border-slate-100 outline-none focus:border-blue-500" id="date-input">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold uppercase text-slate-400">Type</label>
                        <select name="type" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold border border-slate-100 outline-none focus:border-blue-500">
                            <option>EF (Footing)</option>
                            <option>Sortie Longue</option>
                            <option>Trail / D+</option>
                            <option>VMA / Seuil</option>
                            <option>PPG Seule</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold uppercase text-slate-400">Dist. (km)</label>
                        <input name="km" type="number" step="0.1" placeholder="0.0" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold border border-slate-100 outline-none focus:border-blue-500">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold uppercase text-slate-400">D+ (m)</label>
                        <input name="dPlus" type="number" placeholder="0" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold border border-slate-100 outline-none focus:border-blue-500">
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold uppercase text-slate-400">Durée</label>
                        <input name="duration" type="text" placeholder="h:mm" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold border border-slate-100 outline-none focus:border-blue-500">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold uppercase text-slate-400">FC Moy</label>
                        <input name="avgHr" type="number" placeholder="BPM" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold border border-slate-100 outline-none focus:border-blue-500">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold uppercase text-slate-400">RPE</label>
                        <input name="rpe" type="number" min="1" max="10" placeholder="1-10" required class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold border border-slate-100 outline-none focus:border-blue-500">
                    </div>
                </div>
                <div class="flex items-center gap-3 bg-slate-50 p-3 rounded-xl border border-slate-100">
                    <input type="checkbox" name="ppg" id="ppg-check" class="w-5 h-5 accent-blue-600 rounded">
                    <label htmlFor="ppg-check" class="text-sm font-bold text-slate-600">Session PPG incluse ?</label>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-500/20 active:scale-95 transition-all">ENREGISTRER</button>
            </form>
        </div>
    </div>

    <!-- ======================================================= -->
    <!-- LOGIQUE JAVASCRIPT AVEC FIREBASE SANS LOGIN             -->
    <!-- ======================================================= -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, deleteDoc, doc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // =========================================================================
        // CONFIGURATION AUTOMATIQUE
        // =========================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyByuABj8lDBXQWQI_V-Gsk-iN4XwbNk5UI",
            authDomain: "road-to-gt85.firebaseapp.com",
            projectId: "road-to-gt85",
            storageBucket: "road-to-gt85.firebasestorage.app",
            messagingSenderId: "337729038344",
            appId: "1:337729038344:web:37c9b098976b67558cc9bd",
            measurementId: "G-3RZFR8H9CN"
        };
        // =========================================================================


        // --- Données Statiques ---
        const PPG_EXERCISES = [
            { id: 'chaise', name: "Chaise (Mur)", info: "4x45s • Cuisses" },
            { id: 'squat', name: "Squats", info: "3x20 • Puissance" },
            { id: 'fentes', name: "Fentes", info: "3x12/j • Stabilité" },
            { id: 'gainage', name: "Gainage", info: "4x1min • Tronc" },
            { id: 'proprio', name: "Proprioception", info: "3x30s • Chevilles" }
        ];

        const GEAR_ITEMS = [
            { id: 'sac', name: "Sac 12L", model: "Salomon Adv Skin", price: 120, status: 'A acheter' },
            { id: 'batons', name: "Bâtons", model: "Leki Ultratrail", price: 180, status: 'A acheter' },
            { id: 'shoes', name: "Chaussures", model: "Hoka Speedgoat", price: 160, status: 'Acquis' },
            { id: 'lamp', name: "Frontale", model: "Petzl Swift RL", price: 100, status: 'A acheter' }
        ];

        // --- Initialisation ---
        let app, db, userId;

        // Fonction pour générer un ID unique par téléphone sans se connecter
        function getDeviceId() {
            let id = localStorage.getItem('gt85_device_id');
            if (!id) {
                id = 'user_' + Math.random().toString(36).substr(2, 9) + Date.now();
                localStorage.setItem('gt85_device_id', id);
            }
            return id;
        }

        function initApp() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                userId = getDeviceId(); 

                // Mise à jour de l'affichage de l'ID dans les réglages
                document.getElementById('current-user-id').innerText = userId;

                // On lance la connexion
                console.log("Démarrage avec ID :", userId);
                initDataListeners();

            } catch (e) {
                console.error("Erreur Init:", e);
                alert("Erreur: " + e.message);
            }
        }

        // --- Logique Application ---

        function initDataListeners() {
            // 1. Écouteur Sessions
            const qSessions = query(collection(db, `users/${userId}/sessions`), orderBy("date", "desc"));
            onSnapshot(qSessions, (snapshot) => {
                document.getElementById('loading').style.display = 'none';
                const sessions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSessions(sessions);
                calculateStats(sessions);
            }, (error) => {
                console.error("Erreur Droits:", error);
                if(error.code === 'permission-denied') {
                    alert("ERREUR : Tu n'as pas changé les Règles dans Firestore ! Mets 'allow read, write: if true;'");
                }
            });

            // 2. Écouteur PPG Check
            const qPPG = collection(db, `users/${userId}/ppg_status`);
            onSnapshot(qPPG, (snapshot) => {
                const ppgStatus = {};
                snapshot.docs.forEach(doc => ppgStatus[doc.id] = doc.data().done);
                renderPPG(ppgStatus);
            });

            // 3. Écouteur Gear
            const qGear = collection(db, `users/${userId}/gear_status`);
            onSnapshot(qGear, (snapshot) => {
                const gearStatus = {};
                snapshot.docs.forEach(doc => gearStatus[doc.id] = doc.data().status);
                renderGear(gearStatus);
            });
        }

        // --- Actions Firestore ---

        async function addSession(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            try {
                await addDoc(collection(db, `users/${userId}/sessions`), {
                    date: formData.get('date'),
                    type: formData.get('type'),
                    km: parseFloat(formData.get('km') || 0),
                    dPlus: parseInt(formData.get('dPlus') || 0),
                    duration: formData.get('duration') || '--:--',
                    avgHr: parseInt(formData.get('avgHr') || 0),
                    rpe: parseInt(formData.get('rpe') || 0),
                    ppg: formData.get('ppg') === 'on',
                    timestamp: new Date()
                });
                closeModal();
                e.target.reset();
            } catch (err) {
                console.error("Erreur ajout:", err);
                alert("Erreur sauvegarde : " + err.message);
            }
        }

        window.deleteSession = async (id) => {
            if(confirm('Supprimer ?')) {
                await deleteDoc(doc(db, `users/${userId}/sessions`, id));
            }
        }

        window.togglePPG = async (id, status) => {
            await setDoc(doc(db, `users/${userId}/ppg_status`, id), { done: status }, { merge: true });
        }

        window.toggleGear = async (id, status) => {
            await setDoc(doc(db, `users/${userId}/gear_status`, id), { status: status }, { merge: true });
        }
        
        window.resetPPG = async () => {
             PPG_EXERCISES.forEach(async (ex) => {
                 await setDoc(doc(db, `users/${userId}/ppg_status`, ex.id), { done: false });
             });
        }

        // --- Fonctions de Réglages ---
        window.openSettings = () => {
            document.getElementById('settings-modal').classList.remove('hidden');
        }
        window.closeSettings = () => {
            document.getElementById('settings-modal').classList.add('hidden');
        }
        window.copyId = () => {
            const id = document.getElementById('current-user-id').innerText;
            navigator.clipboard.writeText(id).then(() => alert('ID copié !'));
        }
        window.saveNewId = (e) => {
            e.preventDefault();
            const newId = e.target.newId.value.trim();
            if(newId) {
                if(confirm("Attention : Cela va charger les données de cet identifiant. Continuer ?")) {
                    localStorage.setItem('gt85_device_id', newId);
                    window.location.reload();
                }
            }
        }

        // --- Rendu HTML ---
        
        function renderSessions(sessions) {
            const container = document.getElementById('sessions-list');
            container.innerHTML = '';
            if(sessions.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-400 py-10 italic">Aucune séance.</p>';
                return;
            }
            sessions.forEach(s => {
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex items-center justify-between";
                div.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-[10px] font-bold text-blue-500 uppercase bg-blue-50 px-2 py-0.5 rounded">${new Date(s.date).toLocaleDateString('fr-FR', {day: '2-digit', month: '2-digit'})}</span>
                            <span class="text-xs font-bold text-slate-700">${s.type}</span>
                        </div>
                        <div class="flex gap-3 text-sm font-black text-slate-800">
                           <span>${s.km} km</span><span class="text-slate-300">|</span><span>${s.dPlus} m D+</span>
                        </div>
                        <div class="flex gap-3 text-xs text-slate-500 font-medium mt-1">
                           <span class="flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> ${s.duration}</span>
                           ${s.avgHr > 0 ? `<span class="flex items-center gap-1"><i data-lucide="heart" class="w-3 h-3 text-red-500"></i> ${s.avgHr} bpm</span>` : ''}
                        </div>
                        ${s.ppg ? '<span class="text-[9px] text-emerald-600 font-bold flex items-center gap-1 mt-1"><i data-lucide="check-circle-2" class="w-3 h-3"></i> PPG INCLUSE</span>' : ''}
                    </div>
                    <button onclick="deleteSession('${s.id}')" class="text-slate-300 hover:text-red-500 p-2"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                `;
                container.appendChild(div);
            });
            lucide.createIcons();
        }

        function calculateStats(sessions) {
            // Stats globales
            const totalKm = sessions.reduce((acc, s) => acc + (parseFloat(s.km) || 0), 0);
            const totalDPlus = sessions.reduce((acc, s) => acc + (parseInt(s.dPlus) || 0), 0);
            const avgRPE = sessions.length ? (sessions.reduce((acc, s) => acc + (parseInt(s.rpe) || 0), 0) / sessions.length).toFixed(1) : 0;
            const ppgCount = sessions.filter(s => s.ppg).length;
            
            document.getElementById('stat-km').innerText = totalKm.toFixed(1);
            document.getElementById('stat-dplus').innerText = totalDPlus;
            document.getElementById('stat-rpe').innerText = avgRPE;
            document.getElementById('stat-ppg').innerText = ppgCount;

            // Stats Hebdomadaires
            const now = new Date();
            const dayOfWeek = now.getDay(); 
            const distToMonday = (dayOfWeek + 6) % 7; 
            const thisMonday = new Date(now);
            thisMonday.setDate(now.getDate() - distToMonday);
            thisMonday.setHours(0,0,0,0);

            const nextMonday = new Date(thisMonday);
            nextMonday.setDate(thisMonday.getDate() + 7);

            const lastMonday = new Date(thisMonday);
            lastMonday.setDate(thisMonday.getDate() - 7);

            let currentWeekKm = 0, currentWeekDplus = 0;
            let lastWeekKm = 0, lastWeekDplus = 0;

            sessions.forEach(s => {
                const parts = s.date.split('-');
                const sDate = new Date(parts[0], parts[1]-1, parts[2]); 
                
                if (sDate >= thisMonday && sDate < nextMonday) {
                    currentWeekKm += (parseFloat(s.km) || 0);
                    currentWeekDplus += (parseInt(s.dPlus) || 0);
                } else if (sDate >= lastMonday && sDate < thisMonday) {
                    lastWeekKm += (parseFloat(s.km) || 0);
                    lastWeekDplus += (parseInt(s.dPlus) || 0);
                }
            });

            document.getElementById('current-week-km').innerText = currentWeekKm.toFixed(1);
            document.getElementById('current-week-dplus').innerText = currentWeekDplus;
            document.getElementById('last-week-km').innerText = lastWeekKm.toFixed(1);
            document.getElementById('last-week-dplus').innerText = lastWeekDplus;
        }

        function renderPPG(statusMap) {
            const container = document.getElementById('ppg-list');
            container.innerHTML = '';
            PPG_EXERCISES.forEach(ex => {
                const isDone = statusMap[ex.id] === true;
                const div = document.createElement('div');
                div.className = `p-4 rounded-2xl border cursor-pointer flex justify-between items-center transition-all ${isDone ? 'bg-emerald-50 border-emerald-200' : 'bg-white border-slate-100'}`;
                div.onclick = () => togglePPG(ex.id, !isDone);
                div.innerHTML = `
                    <div><h4 class="font-bold ${isDone ? 'text-emerald-700 line-through' : 'text-slate-800'}">${ex.name}</h4><p class="text-xs text-slate-500">${ex.info}</p></div>
                    <div class="${isDone ? 'text-emerald-500' : 'text-slate-200'}"><i data-lucide="check-circle-2" class="w-6 h-6"></i></div>`;
                container.appendChild(div);
            });
            lucide.createIcons();
        }

        function renderGear(statusMap) {
            const container = document.getElementById('gear-list');
            container.innerHTML = '';
            GEAR_ITEMS.forEach(item => {
                const currentStatus = statusMap[item.id] || item.status;
                const isAcquired = currentStatus === 'Acquis';
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-4";
                div.innerHTML = `
                    <div class="w-10 h-10 rounded-xl flex items-center justify-center ${isAcquired ? 'bg-emerald-100 text-emerald-600' : 'bg-amber-100 text-amber-600'}"><i data-lucide="package" class="w-5 h-5"></i></div>
                    <div class="flex-1"><h4 class="text-sm font-bold leading-tight">${item.name}</h4><p class="text-[10px] text-slate-500">${item.model}</p></div>
                    <div class="flex flex-col items-end gap-1"><span class="text-[10px] font-black text-blue-600">${item.price}€</span>
                        <button class="gear-toggle text-[9px] font-black px-2 py-1 rounded-lg uppercase tracking-tighter ${isAcquired ? 'bg-emerald-50 text-emerald-700' : 'bg-slate-100 text-slate-600'}" onclick="toggleGear('${item.id}', '${currentStatus === 'Acquis' ? 'A acheter' : 'Acquis'}')">${currentStatus}</button>
                    </div>`;
                container.appendChild(div);
            });
            lucide.createIcons();
        }
        
        // Expose functions to global scope
        window.toggleGear = toggleGear;
        document.getElementById('add-form').addEventListener('submit', addSession);
        
        // Démarrage
        initApp();

    </script>

    <!-- UI Scripts (Onglets & Modales) -->
    <script>
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => { el.classList.remove('text-blue-600', 'active'); el.classList.add('text-slate-400'); });
            document.getElementById('tab-' + tabId).classList.add('active');
            const activeBtn = document.querySelector(`button[onclick="switchTab('${tabId}')"]`);
            if(activeBtn) { activeBtn.classList.remove('text-slate-400'); activeBtn.classList.add('text-blue-600', 'active'); }
        }
        function openModal() { document.getElementById('add-modal').classList.remove('hidden'); document.getElementById('date-input').valueAsDate = new Date(); }
        function closeModal() { document.getElementById('add-modal').classList.add('hidden'); }
        lucide.createIcons();
    </script>
</body>
</html>